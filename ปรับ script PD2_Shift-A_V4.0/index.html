<!DOCTYPE html>
<html lang="th" style="overflow-x:hidden;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2 - ‡∏Å‡∏∞ A </title>
    <script src="https://cdn.tailwindcss.com/3.4.10"></script>
    <script src="../assets/js/i18n-translations.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Prevent horizontal scroll */
        * { 
            max-width: 100vw; 
        }
        html, body {
            overflow-x: hidden !important;
            width: 100%;
            position: relative;
        }
        /* Success Modal Animations */
        @keyframes slideInDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* mobile override: prevent narrow columns and clipping on iOS */
        @media (max-width: 640px) {
            body { background-attachment: scroll !important; }
            .glass-strong, .glass, .data-set { max-width: 100% !important; margin-left: 8px !important; margin-right: 8px !important; box-sizing: border-box !important; }
        }
        * {
            font-family: 'Kanit', sans-serif;
            font-feature-settings: "liga" 1, "kern" 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Remove embossed/raised label effects site-wide for this module
           Keep text color/weight but remove transform and box-shadow used for 'raised' look */
        label.block.font-medium.mb-2.text-base,
        label.block.font-medium.mb-2.text-base * {
            transform: none !important;
            box-shadow: none !important;
        }
        /* Improve label clarity: stronger weight, precise spacing, high contrast */
        label.block.font-medium.mb-2.text-base {
            color: #ffffff !important;
            font-weight: 600 !important; /* semibold for better legibility */
            letter-spacing: 0.005em !important;
        }
        /* Also neutralize strong glass shadows that may create raised appearance */
        .glass, .glass-strong, .glass-light {
            box-shadow: none !important;
            border-radius: 0.5rem; /* preserve rounding */
        }
        
        body {
            font-size: 16px;
            line-height: 1.6;
            letter-spacing: 0.01em;
            font-weight: 400;
            color: #f0f4f8; /* Light color for dark background */
        }
        
        body {
            background-color: #001827; /* deep navy-teal fallback */
            background-image: linear-gradient(160deg, #000482d5 0%, #053f57 45%, #062c65 100%);
            min-height: 100vh;
            font-feature-settings: "liga" 1;
            text-rendering: optimizeLegibility;
        }
        
        .glass {
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô-‡∏°‡πà‡∏ß‡∏á ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏∑‡∏ô‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° */
            background: linear-gradient(180deg, rgba(99,102,241,0.12) 0%, rgba(59,130,246,0.06) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(99,102,241,0.18);
            color: #f8fafc;
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-light {
            /* Darker purple-indigo tone (‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô) ‚Äî ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
            background: linear-gradient(180deg, rgba(67,56,202,0.32) 0%, rgba(49,46,129,0.30) 65%);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.09);
            box-shadow: 0 8px 30px rgba(6, 10, 30, 0.45);
            border-radius: 0.5rem;
            color: #ffffff;
        }
        
        .btn-glow, .button-glow {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-glow:hover, .button-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-glow:hover::before {
            left: 100%;
        }
        

        
        .btn-green { 
            background: linear-gradient(135deg, #16a34a, #22c55e);
            border: 2px solid #15803d;
        }
        .btn-green:hover { 
            background: linear-gradient(135deg, #15803d, #16a34a);
            box-shadow: 0 0 30px rgba(22, 197, 94, 0.6), 0 0 60px rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
        }
        
        .btn-orange { 
            background: linear-gradient(135deg, #ea580c, #f97316);
            border: 2px solid #c2410c;
        }
        .btn-orange:hover { 
            background: linear-gradient(135deg, #c2410c, #ea580c);
            box-shadow: 0 0 30px rgba(234, 88, 12, 0.6), 0 0 60px rgba(249, 115, 22, 0.3);
            border-color: #f97316;
        }
        
        .btn-blue { 
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border: 2px solid #1d4ed8;
        }
        .btn-blue:hover { 
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.6), 0 0 60px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        
        .btn-red { 
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border: 2px solid #b91c1c;
        }
        .btn-red:hover { 
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6), 0 0 60px rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }
        
        .btn-purple { 
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            border: 2px solid #6d28d9;
        }
        .btn-purple:hover { 
            background: linear-gradient(135deg, #6d28d9, #7c3aed);
            box-shadow: 0 0 30px rgba(124, 58, 237, 0.6), 0 0 60px rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
        }
        
        .input-field {
            transition: all 0.3s ease;
            font-size: 15px !important;
            font-weight: 400 !important;
            color: #04121a !important; /* stronger, high-contrast text */
            letter-spacing: 0.01em;
            line-height: 1.4;
            border-width: 1px;
            background: #ffffff !important;
            border-color: #d1d5db !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 2px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6;
            outline: none;
            background: #ffffff !important;
            color: #04121a !important;
        }

        .readonly-field {
            background: #d1d5db !important;
            color: #04121a !important; /* ensure readonly text is high contrast */
            cursor: not-allowed;
            font-weight: 300 !important;
            font-size: 15px !important;
            border-color: #9ca3af !important;
            letter-spacing: 0.01em;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1) !important;
        }

        /* Placeholder color for clarity */
        .input-field::placeholder { color: #6b7280; opacity: 1; }
    /* Wage (Shift-A) numeric style */
    .wage-a-input.valid { color: #0026ae !important; font-weight: 700 !important; }

        /* Instant suggestion panel styling */
        .instant-suggestions, .instant-suggest {
            color: #04121a;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(2,6,23,0.12);
            z-index: 10000;
        }
        .instant-suggestions div, .instant-suggest div { color: #04121a; }
        .instant-suggestions div:hover, .instant-suggest div:hover { background: #eff6ff; }
        
        .data-set {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-step {
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            background: #16a34a;
            color: white;
        }
        
        .progress-step.completed {
            background: #059669;
            color: white;
        }
        
        .notification {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            .input-field {
                font-size: 16px !important;
            }
            
            .btn-glow, .button-glow {
                min-height: 44px;
            }
        }
    </style>
    <!-- LEGACY / OLD MOBILE SUPPORT START -->
    <style>
        /* Fallback ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏ñ‡πâ‡∏≤ gradient ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å) */
        body { background-color:#1e40af; }
        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö backdrop-filter ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏´‡∏ô‡∏≤‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô iOS <12 / Android ‡πÄ‡∏Å‡πà‡∏≤ */
        .no-backdrop .glass,
        .no-backdrop .glass-strong,
        .no-backdrop .glass-light { 
            backdrop-filter:none !important; 
            -webkit-backdrop-filter:none !important; 
            background:rgba(255,255,255,0.88) !important; 
            border-color:rgba(0,0,0,0.08) !important;
        }
        /* ===== ANIMATIONS & TRANSITIONS ===== */
        .btn-glow:hover, .button-glow:hover { transform:none !important; box-shadow:none !important; }
    </style>
    <script>
        /* Feature / capability detection + polyfills loader ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤ */
        (function(){
            var docEl = document.documentElement;
            try {
                // detect backdrop-filter support; if missing, add no-backdrop and apply white 80% fallback
                (function(){
                    var testEl = document.createElement('div');
                    testEl.style.backdropFilter = 'blur(1px)';
                    testEl.style.webkitBackdropFilter = 'blur(1px)';
                    // If neither property is retained by the browser, assume no support
                    if (!(testEl.style.backdropFilter || testEl.style.webkitBackdropFilter)) {
                        docEl.classList.add('no-backdrop');
                        // inject stronger white fallback (80% opacity) for glass layers
                        try {
                            if (!document.getElementById('pd2-no-backdrop-fallback')) {
                                var s = document.createElement('style');
                                s.id = 'pd2-no-backdrop-fallback';
                                s.textContent = '.no-backdrop .glass, .no-backdrop .glass-strong, .no-backdrop .glass-light { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; background: rgba(255,255,255,0.8) !important; border-color: rgba(0,0,0,0.08) !important; color: #04121a !important; }';
                                document.head.appendChild(s);
                            }
                        } catch(_) {}
                    } else {
                        docEl.classList.remove('no-backdrop');
                    }
                })();
            } catch(e){ docEl.classList.add('no-backdrop'); }

            // Polyfill: Promise
            if(typeof Promise === 'undefined'){
                var p = document.createElement('script');
                p.src = 'https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js';
                document.head.appendChild(p);
            }
            // Polyfill: fetch
            if(typeof fetch === 'undefined'){
                var f = document.createElement('script');
                f.src = 'https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.20/dist/fetch.umd.min.js';
                document.head.appendChild(f);
            }
            // Polyfill: IntersectionObserver (‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
            if(!('IntersectionObserver' in window)){
                var io = document.createElement('script');
                io.src = 'https://cdn.jsdelivr.net/npm/intersection-observer@0.12.2/intersection-observer.js';
                document.head.appendChild(io);
            }
            // NodeList.forEach ‡∏ö‡∏ô IE / ‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å (‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô WebView ‡πÄ‡∏Å‡πà‡∏≤)
            if(window.NodeList && !NodeList.prototype.forEach){
                NodeList.prototype.forEach = Array.prototype.forEach;
            }
            // classList ‡∏ö‡∏≤‡∏á WebView ‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≤‡∏î (‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏¥‡∏ß‡πÄ‡∏ú‡∏¥‡∏ô)
            if(!('classList' in document.createElement('_'))){
                try { (document.createElement('script').src='https://unpkg.com/classlist-polyfill@1.2.0/src/index.js'); } catch(e){}
            }
        })();
    </script>
    <!-- LEGACY / OLD MOBILE SUPPORT END -->
        <script>
            // Notify parent frame that content is ready for faster navigation (send once only)
            (function(){
                let readySent = false;
                function trySendReady(){
                    if (readySent) return;
                    try {
                        if (window.parent && window.parent !== window) {
                            window.parent.postMessage({ type: 'PD2_READY' }, '*');
                            readySent = true;
                            console.debug('[PD2_MODULE] Sent PD2_READY from head');
                            return true;
                        }
                    } catch(e){
                        console.warn('[PD2_MODULE] Failed to send PD2_READY', e);
                    }
                    return false;
                }
                try {
                    // ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
                    if (document.readyState === 'complete' || document.readyState === 'interactive') {
                        setTimeout(trySendReady, 0);
                    } else {
                        window.addEventListener('DOMContentLoaded', () => { trySendReady(); }, { once: true });
                    }
                } catch(e){
                    console.debug('[PD2_MODULE] PD2_READY sender setup failed', e);
                }
            })();
        </script>
</head>
<!-- mobile responsive fix: add bottom safe-area padding for Android navbar avoidance -->
<body class="min-h-screen pb-[env(safe-area-inset-bottom,0)]" style="overflow-x:hidden;">
    <!-- Header Section -->
    <div class="glass-strong rounded-lg mx-4 mt-4 p-6 mb-6 relative">
        <!-- Back to Home Button (Mobile-First Navigation) -->
        <a href="../index.html" class="absolute top-4 left-4 flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 z-10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span class="font-medium" data-i18n="nav.back">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </a>
        
        <!-- Language Selector Button (Top Right) -->
        <div class="absolute top-4 right-4 z-10">
            <button onclick="toggleLanguageMenu()" class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                </svg>
                <span class="font-medium" id="currentLanguage">‡πÑ‡∏ó‡∏¢</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            
            <!-- Language Dropdown Menu -->
            <div id="languageMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl overflow-hidden z-20">
                <button onclick="changeLanguage('th')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors flex items-center gap-2 border-b">
                    <span class="text-2xl">üáπüá≠</span>
                    <span class="font-medium text-gray-700">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</span>
                </button>
                <button onclick="changeLanguage('en')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors flex items-center gap-2 border-b">
                    <span class="text-2xl">üá¨üáß</span>
                    <span class="font-medium text-gray-700">English</span>
                </button>
                <button onclick="changeLanguage('my')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors flex items-center gap-2 border-b">
                    <span class="text-2xl">üá≤üá≤</span>
                    <span class="font-medium text-gray-700">·Äô·Äº·Äî·Ä∫·Äô·Ä¨</span>
                </button>
                <button onclick="changeLanguage('mnw')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors flex items-center gap-2">
                    <span class="text-2xl">üåê</span>
                    <span class="font-medium text-gray-700">·Äô·Äî·Ä∫ (Mon)</span>
                </button>
            </div>
        </div>
        
        <div class="text-center mb-4 pt-12">
            <h1 class="text-3xl font-medium text-gray-800 tracking-normal leading-relaxed" data-i18n="system.title">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2</h1>
            <div class="w-16 h-0.5 bg-gray-400 mx-auto mt-3"></div>
        </div>
        
        <!-- Status Bar -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-white rounded-lg p-4">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="statusGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#statusGrad)" cx="12" cy="12" r="10"/>
                    <path stroke="white" stroke-width="2" d="m9 12 2 2 4-4"/>
                </svg>
                <span class="font-normal text-gray-700 text-sm md:text-base" data-i18n="status.ready">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </div>
            
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="shiftGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#shiftGrad)" cx="12" cy="12" r="5"/>
                    <line stroke="white" stroke-width="2" x1="12" y1="1" x2="12" y2="3"/>
                    <line stroke="white" stroke-width="2" x1="12" y1="21" x2="12" y2="23"/>
                    <line stroke="white" stroke-width="2" x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line stroke="white" stroke-width="2" x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line stroke="white" stroke-width="2" x1="1" y1="12" x2="3" y2="12"/>
                    <line stroke="white" stroke-width="2" x1="21" y1="12" x2="23" y2="12"/>
                    <line stroke="white" stroke-width="2" x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line stroke="white" stroke-width="2" x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <span class="font-normal text-gray-700 text-sm md:text-base" data-i18n="shift.a">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏∞ A (08:00-20:00 ‡∏ô.)</span>
            </div>
            
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="timeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#timeGrad)" cx="12" cy="12" r="10"/>
                    <polyline stroke="white" stroke-width="2" points="12,6 12,12 16,14"/>
                </svg>
                <span class="font-normal text-gray-700 text-sm md:text-base" id="currentTime"></span>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="glass rounded-lg mx-4 mb-6 p-6">
        <div class="flex justify-center">
            <div class="flex items-center bg-white rounded-lg px-4 py-2">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="dataGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect fill="url(#dataGrad)" x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line stroke="white" stroke-width="2" x1="16" y1="2" x2="16" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="8" y1="2" x2="8" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span class="font-normal text-gray-700 text-base" style="color:#000000;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span id="dataSetCount" class="text-blue-600 font-medium" style="color:#ff0000;">1</span>/100</span>
            </div>
        </div>
    </div>

    <!-- Data Entry Container -->
    <div id="dataContainer" class="mx-4 space-y-6">
        <!-- Data sets will be generated here -->
    </div>

    <!-- Quick Actions Box -->
    <div class="glass rounded-lg mx-4 my-6 p-6 w-full max-w-full">
        <h3 class="text-white text-lg font-semibold mb-4 text-center"></h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 w-full">
            <button onclick="addDataSet()" class="btn-glow btn-green text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                </svg>
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</span>
            </button>
            <button onclick="copyAndAddDataSet()" class="btn-glow btn-blue text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
                <span>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
            <button onclick="resetToSingleDataSet()" class="btn-glow btn-red text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 5V2L8 6l4 4V7c2.757 0 5 2.243 5 5a5 5 0 0 1-5 5c-2.05 0-3.813-1.232-4.58-3H5.35c.84 3.45 3.95 6 7.65 6 4.418 0 8-3.582 8-8s-3.582-8-8-8z"/>
                </svg>
                <span>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </button>
            <button onclick="exportPNG()" class="btn-glow text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform" style="background: linear-gradient(135deg, #f50494, #c0037a);">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5l2 2.5 3-4 4.5 6H6l2.5-4.5z"/>
                </svg>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="glass rounded-lg mx-4 my-6 p-6 w-full max-w-full">
        <h3 class="text-white text-lg font-semibold mb-4 text-center"></h3>
        <div class="flex justify-center">
            <button onclick="submitData()" class="btn-glow btn-orange text-white px-8 py-5 rounded-xl font-semibold text-lg flex items-center justify-center gap-3 w-full sm:w-auto min-w-[280px] hover:scale-105 transition-transform shadow-xl">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Success Modal with Auto-Reset -->
    <div id="successModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.7);">
        <div class="glass-strong rounded-2xl w-full sm:max-w-2xl p-10 shadow-2xl" style="animation: slideInDown 0.3s ease-out;">
            <div class="text-center mb-8">
                <div class="mx-auto w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mb-5" style="animation: scaleIn 0.5s ease-out;">
                    <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h3 class="text-3xl font-bold text-gray-800 mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
                <p class="text-gray-600 text-xl"><span id="successModalCount" class="font-bold text-green-600 text-2xl">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mb-6 border-2 border-blue-200">
                <p class="text-gray-700 font-medium text-center mb-2">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠?</p>
                <div class="text-center">
                    <p class="text-sm text-gray-600">‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô <span id="countdownTimer" class="font-bold text-2xl text-blue-600">90</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...</p>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="continueWithSameEmployee()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-5 rounded-xl font-semibold text-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 text-center">
                    <div class="leading-tight">
                        <div class="text-xl mb-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠</div>
                        <div class="text-sm opacity-90">(‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</div>
                    </div>
                </button>
                <button onclick="resetForNextEmployee()" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-5 rounded-xl font-semibold text-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 text-center">
                    <div class="leading-tight">
                        <div class="text-xl mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div>
                        <div class="text-sm opacity-90">(‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)</div>
                    </div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Machine Modal -->
    <div id="machineModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="machineGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#7c3aed;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#5b21b6;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#machineGrad)" x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line stroke="white" stroke-width="2" x1="8" y1="21" x2="16" y2="21"/>
                        <line stroke="white" stroke-width="2" x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠‡πÉ‡∏´‡∏°‡πà
                </h3>
                <button onclick="closeModal('machine')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newMachine" placeholder="‡πÄ‡∏ä‡πà‡∏ô CL96" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('machine')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="closeModal('machine')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="employeeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#059669;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#047857;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#employeeGrad)" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                </h3>
                <button onclick="closeModal('employee')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newEmployeeId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ZP99999" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-3">
            <input type="text" id="newEmployeeName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('employee')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="closeModal('employee')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Fabric Size Modal -->
    <div id="fabricModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="fabricGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#b91c1c;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#fabricGrad)" x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <path stroke="white" stroke-width="2" d="m9 9 3 3-3 3m6-6h-6"/>
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                </h3>
                <button onclick="closeModal('fabric')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newFabricSize" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2025800SMN" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('fabric')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="closeModal('fabric')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center">
        <div class="glass-strong rounded-lg p-6 w-full sm:max-w-sm mx-4">
            <div class="text-center space-y-4">
                <div class="mx-auto w-14 h-14 relative">
                    <div class="pd2-spinner" aria-hidden="true"></div>
                    <div class="sr-only" role="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p class="text-gray-600 mb-4" id="loadingStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                
                <!-- Progress Steps -->
                <div class="flex justify-between mb-4">
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step1">1</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step2">2</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step3">3</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step4">4</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step5">5</div>
                </div>

                <style>
                @keyframes pd2Spin { to { transform: rotate(360deg); } }
                .pd2-spinner { width:100%; height:100%; box-sizing:border-box; border:3px solid rgba(0,0,0,0.07); border-top-color:var(--color-accent,#10b981); border-radius:50%; animation: pd2Spin .8s linear infinite; }
                </style>
                
                <div class="text-sm text-gray-500">
                    <div>1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div>2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div>3. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</div>
                    <div>4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div>5. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Recovery Modal -->
    <div id="recoveryModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center mb-4">
                <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="recoveryGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#recoveryGrad)" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                <h3 class="text-xl font-bold text-gray-800">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á</h3>
            </div>
            <p class="text-gray-600 mb-6">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex gap-3">
                <button onclick="retryPendingSubmission()" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
                <button onclick="discardPendingSubmission()" class="btn-glow btn-red text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script>
        // Debug badge overlay (non-invasive) ‚Äî disabled by default
        var PD2_DEBUG_ON = false;
        try {
            const qs = new URLSearchParams(window.location.search);
            PD2_DEBUG_ON = (qs.has('pd2debug') || qs.get('debug') === '1' || localStorage.getItem('PD2_DEBUG') === '1');
        } catch(_){}
        function PD2DebugBadge(msg) {
            if (!PD2_DEBUG_ON) return;
            try {
                let badge = document.getElementById('pd2-debug-badge');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.id = 'pd2-debug-badge';
                    Object.assign(badge.style, {
                        position: 'fixed', top: '8px', right: '8px', zIndex: 99999,
                        background: 'rgba(0,0,0,0.7)', color: '#fff', fontSize: '12px',
                        padding: '6px 10px', borderRadius: '8px', boxShadow: '0 2px 8px rgba(0,0,0,0.18)',
                        pointerEvents: 'none'
                    });
                    document.body.appendChild(badge);
                }
                badge.textContent = String(msg || '');
                badge.style.display = 'block';
                setTimeout(() => { if (badge) badge.style.display = 'none'; }, 2200);
            } catch(_){}
        }

        // Master Data Arrays
        const machines = [
            "CL1","CL2","CL3","CL4","CL5","CL6","CL7","CL8","CL9","CL12","CL13","CL14",
            "CL15","CL16","CL17","CL19","CL25","CL26","CL27","CL28","CL29","CL30","CL31",
            "CL32","CL33","CL44","CL45","CL46","CL47","CL48","CL49","CL50","CL51","CL52",
            "CL53","CL54","CL55","CL56","CL57","CL58","CL59","CL60","CL61","CL62","CL63",
            "CL64","CL65","CL66","CL67","CL68","CL69","CL70","CL71","CL72","CL73","CL74",
            "CL75","CL76","CL77","CL78","CL79","CL80","CL81","CL82","CL83","CL84","CL85",
            "CL86","CL87","CL88","CL89","CL90","CL91","CL92","CL93","CL94","CL95",
            "CL34","CL35","CL36"
        ];

        // Combined machine list (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠) ‚Äî ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        const combinedMachines = [
            "CL1 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL2 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL3 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL4 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL5 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL6 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL7 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL8 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL9 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL12 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL13 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL14 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL15 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL16 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL17 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL19 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL25 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL26 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL27 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL28 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL29 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL30 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL31 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL32 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL33 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL44 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL45 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL46 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL47 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL48 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL49 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL50 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL51 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL52 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL53 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL54 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL55 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL56 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL57 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL58 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL59 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL60 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL61 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL62 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL63 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL64 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL65 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL66 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL67 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL68 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL69 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL70 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL71 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL72 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL73 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL74 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL75 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL76 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL77 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL78 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL79 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL80 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL81 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL82 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL83 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL84 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL85 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL86 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL87 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL88 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL89 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL90 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL91 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL92 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL93 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL94 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL95 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL34 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL35 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2", "CL36 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2",
            "CL1 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL2 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL3 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL4 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL5 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL6 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL7 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL8 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL9 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL12 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL13 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL14 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL15 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL16 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL17 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL19 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL25 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL26 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL27 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL28 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL29 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL30 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL31 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL32 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL33 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL44 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL45 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL46 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL47 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL48 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL49 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL50 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL51 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL52 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL53 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL54 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL55 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL56 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL57 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL58 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL59 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL60 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL61 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL62 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL63 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL64 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL65 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL66 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL67 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL68 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL69 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL70 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL71 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL72 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL73 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL74 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL75 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL76 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL77 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL78 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL79 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL80 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL81 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL82 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL83 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL84 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL85 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL86 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL87 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL88 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL89 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL90 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL91 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL92 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL93 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL94 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3",
            "CL95 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL34 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL35 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3", "CL36 ‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3"
        ];

        // ‡∏£‡∏ß‡∏° combinedMachines ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô machines ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        machines.push(...combinedMachines);
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ -> "‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2" -> "‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3" ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î CL34-36 ‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°
        const preferredOrderBase = [
            "CL1","CL2","CL3","CL4","CL5","CL6","CL7","CL8","CL9","CL12","CL13","CL14",
            "CL15","CL16","CL17","CL19","CL25","CL26","CL27","CL28","CL29","CL30","CL31",
            "CL32","CL33","CL44","CL45","CL46","CL47","CL48","CL49","CL50","CL51","CL52",
            "CL53","CL54","CL55","CL56","CL57","CL58","CL59","CL60","CL61","CL62","CL63",
            "CL64","CL65","CL66","CL67","CL68","CL69","CL70","CL71","CL72","CL73","CL74",
            "CL75","CL76","CL77","CL78","CL79","CL80","CL81","CL82","CL83","CL84","CL85",
            "CL86","CL87","CL88","CL89","CL90","CL91","CL92","CL93","CL94","CL95",
            "CL34","CL35","CL36"
        ];
        const orderMap = new Map(preferredOrderBase.map((id, idx) => [parseInt(id.replace(/^CL/i, ''), 10), idx]));
        const phaseRank = (s) => {
            const m = s.match(/‡∏Ñ‡∏£‡∏±‡πâ‡∏á\s*(\d+)/);
            const p = m ? parseInt(m[1], 10) : 0;
            return p === 2 ? 1 : p === 3 ? 2 : 0; // 0 (‡∏õ‡∏Å‡∏ï‡∏¥), 1 (‡∏Ñ‡∏£‡∏±‡πâ‡∏á 2), 2 (‡∏Ñ‡∏£‡∏±‡πâ‡∏á 3)
        };
        const machineComparator = (a, b) => {
            const pa = phaseRank(a);
            const pb = phaseRank(b);
            if (pa !== pb) return pa - pb;
            const nAraw = (a.match(/^CL(\d+)/i) || [])[1];
            const nBraw = (b.match(/^CL(\d+)/i) || [])[1];
            const idxA = nAraw ? (orderMap.get(parseInt(nAraw, 10)) ?? Number.MAX_SAFE_INTEGER) : Number.MAX_SAFE_INTEGER;
            const idxB = nBraw ? (orderMap.get(parseInt(nBraw, 10)) ?? Number.MAX_SAFE_INTEGER) : Number.MAX_SAFE_INTEGER;
            if (idxA !== idxB) return idxA - idxB;
            return a.localeCompare(b, 'th');
        };
        machines.sort(machineComparator);

        const employees = [
            { "id": "ZP91042", "name": "‡∏ô‡∏≤‡∏¢ ‡∏ß‡∏±‡∏ô ‡∏ä‡∏±‡∏¢" },
            { "id": "ZP91385", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏£‡∏±‡∏ê‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏ô‡∏¥‡∏ò‡∏≤‡∏Å‡∏£‡∏ì‡πå" },
            { "id": "ZP92285", "name": "‡∏ô‡∏≤‡∏¢‡∏ï‡∏≤‡∏•‡∏ã‡∏¥‡∏ô ‡∏≠‡∏≠‡∏á" },
            { "id": "ZP91702", "name": "‡∏ô‡∏≤‡∏¢ ‡∏û‡∏¥‡∏ß ‡πÑ‡∏ß ‡∏à‡∏≠" },
            { "id": "ZP92237", "name": "‡∏ã‡∏≠ ‡∏û‡∏π ‡∏¢‡∏≤ ‡∏ã‡∏≤" },
            { "id": "ZP92286", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏ã‡∏¥‡∏Å ‡πÄ‡∏Ñ‡πà‡∏ô" },
            { "id": "ZP92250", "name": "‡∏¢‡∏∏‡∏ô ‡∏ß‡∏≤ ‡∏ï‡∏¥" },
            { "id": "ZP91720", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏à‡∏π ‡∏à‡∏π ‡∏ã‡∏≤‡∏ô" },
            { "id": "ZP92187", "name": "‡∏ï‡∏¥‡∏ô ‡πÇ‡∏° ‡πÅ‡∏ó‡πá‡∏Ñ" },
            { "id": "ZP92282", "name": "‡∏õ‡∏≤‡∏•‡∏≤‡∏°‡∏≠‡∏ô" },
            { "id": "ZP91922", "name": "‡∏ô‡∏≤‡∏¢ ‡πÄ‡∏û‡∏µ‡∏¢ ‡πÇ‡∏ã ‡∏≠‡∏π" },
            { "id": "ZP92434", "name": "‡∏ô.‡∏™.‡∏•‡∏≥‡πÑ‡∏¢ ‡πÉ‡∏à‡∏ä‡∏∑‡πà‡∏≠" },
            { "id": "ZP92471", "name": "‡∏ô‡∏≤‡∏á‡∏°‡∏≠‡∏ß ‡∏°‡∏≠‡∏ß ‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91512", "name": "‡∏ô‡∏≤‡∏á ‡∏ô‡∏±‡∏ô ‡∏°‡∏≤ ‡πÄ‡∏• ‡∏¢‡∏µ" },
            { "id": "ZP92321", "name": "‡∏ô.‡∏™.‡∏°‡∏∞‡∏ã‡∏π‡∏ã‡∏π‡πÄ‡∏¢" },
            { "id": "ZP92491", "name": "‡∏ô‡∏≤‡∏á‡∏°‡∏≤ ‡∏ó‡∏≤‡∏ã‡∏¥‡∏ô ‡∏°‡∏ô" },
            { "id": "ZP91680", "name": "‡∏ô‡∏≤‡∏á ‡∏ï‡∏¥‡∏ô ‡∏ã‡∏∏‡∏¢" },
            { "id": "ZP9499", "name": "‡∏ô‡∏≤‡∏á ‡∏à‡∏≥‡∏£‡∏±‡∏® ‡∏û‡∏∏‡∏ó‡∏ò‡∏≤" },
            { "id": "ZP91569", "name": "‡∏ô‡∏≤‡∏¢ ‡∏ß‡∏±‡∏ä‡∏ä‡∏£‡∏∞ ‡∏ä‡∏∞‡∏é‡∏≤‡∏î‡∏≥" },
            { "id": "ZP92350", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏ã‡∏¥‡∏ô‡∏°‡∏≤‡∏•‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91719", "name": "‡∏ô‡∏≤‡∏¢ ‡∏û‡∏µ ‡∏û‡∏¥‡∏ß ‡∏≠‡∏≠‡∏á" },
            { "id": "ZP9060", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏≠‡∏±‡∏á‡∏Ñ‡∏ì‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏ò‡∏£‡∏£‡∏°" },
            { "id": "ZP92495", "name": "‡∏ô‡∏≤‡∏á‡∏û‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå" },
            { "id": "ZP9174", "name": "‡∏ô‡∏≤‡∏á ‡∏£‡∏±‡∏î‡∏î‡∏≤ ‡∏®‡∏£‡∏µ‡∏ó‡∏≠‡∏á" },
            { "id": "ZP92186", "name": "‡∏ã‡∏≤‡∏°‡∏¥‡∏ô‡∏≠‡∏π" },
            { "id": "ZP92317", "name": "‡∏ô‡∏≤‡∏¢ ‡∏¢‡∏≤‡∏ô ‡∏•‡∏¥‡∏ô ‡∏≠‡∏≠‡∏á" },
            { "id": "ZP92402", "name": "‡∏ô‡∏≤‡∏¢ ‡∏•‡∏≤ ‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91718", "name": "‡∏ô‡∏≤‡∏¢ ‡∏´‡∏°‡πà‡∏≠‡∏á ‡∏ã‡∏≠" },
            { "id": "ZP92425", "name": "‡∏ô.‡∏™.‡∏ß‡∏¥" },
            { "id": "ZP92318", "name": "‡∏ô.‡∏™.‡∏Ñ‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91617", "name": "‡∏ô‡∏≤‡∏á ‡∏û‡∏¥‡πÑ‡∏•‡∏û‡∏£‡∏£‡∏ì ‡πÄ‡∏ï‡πÇ‡∏ä" },
            { "id": "ZP92481", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏ï‡∏¥‡πà‡∏ô ‡∏ã‡∏≤" },
            { "id": "ZP92390", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡πÄ‡∏≠ ‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP92107", "name": "‡∏ô‡∏≤‡∏á ‡∏à‡∏µ ‡∏õ‡∏¥‡∏¢‡∏õ‡∏£‡∏∞‡∏†‡∏≤‡∏Å‡∏∏‡∏•" }
        ];

        const fabricSizes = [
            // Merged old + new (updated 2025-09-17). Rule: sort by first two leading digits ascending; entries that are not purely 2 starting digits (contain letter in first 2 chars or start with letter) placed at end.
            // --- Numeric-first groups ---
            "1425800",
            "1621720SMFX",
            "1625800",
            "1625800SM",
            "1725800",
            "1825800SM",
            "1921720",
            "19251000SM",
            "1925800",
            "1925800SM",
            "2021720UV",
            "2021750",
            "2021800",
            "2021850",
            "2021850UV",
            "20251000",
            "2025650",
            "2025700",
            "2025800",
            "2025800SM",
            "2025800SMN",
            "2025850",
            "2121670SM",
            "2125650",
            "2125700",
            "2125800",
            "2221940",
            "23211125120SMFX",
            "23211125130",
            "2321112514051",
            "2321112512551",
            "2321750",
            "2325650",
            "2325800SM",
            "2421112512551",
            "2625650",
            "262575051",
            "2625800",
            "2625850SM",
            "2825850",
            // --- Non-numeric / mixed prefix ---
            "1R042325650",
            "FCL022325650",
            "SCL0223211125",
            "scl052325650",
            "test2025800"
        ];

        // API Configuration - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        const API_CONFIG = {
            // Primary endpoint (updated 2025-08-13)
            endpoint: 'https://script.google.com/macros/s/AKfycbzwXk9eEc2BXuYeQ-9Zdz6nR9gL-dzBIye4uzWRowL-cAppBfSAvexodfMESlfx2FC8/exec',
            
            // Backup endpoints (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ primary ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
            backupEndpoints: [
                'https://script.google.com/macros/s/BACKUP_URL_1/exec',
                'https://script.google.com/macros/s/BACKUP_URL_2/exec'
            ],
            
            sheetId: '1K9e_VNW34yF_nVFCXW3v6W8v7FAt33Gr9xnuwCHBadc',
            folderId: '1O07zs3-Vm7W42DvkHg1RU6BKcw60zljV',
            
            // Timeout ‡πÅ‡∏•‡∏∞ retry settings
            timeout: 30000, // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            maxRetries: 5,
            retryDelay: 2000, // 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            
            // Version tracking
            apiVersion: '1.0',
            lastUpdated: '2024-12-19'
        };

        // Global Variables
        let dataSetCount = 1;
    let autoSaveInterval;
    let debounceTimer;
    // Track the select that triggered ADD_NEW so only it gets the new selection
    let addNewContext = null;
        
        // System Health Monitoring
        const SYSTEM_HEALTH = {
            lastSaveTime: null,
            saveFailureCount: 0,
            maxFailures: 10,
            isOnline: navigator.onLine,
            performanceMetrics: {
                loadTime: 0,
                saveTime: 0,
                errorCount: 0
            }
        };
        
        // Error Logging System
        const ERROR_LOG = {
            maxEntries: 100,
            entries: [],
            
            log: function(error, context = '') {
                const entry = {
                    timestamp: new Date().toISOString(),
                    error: error.toString(),
                    context: context,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                this.entries.unshift(entry);
                if (this.entries.length > this.maxEntries) {
                    this.entries.pop();
                }
                
                // Save to localStorage for debugging
                try {
                    LS.set('errorLog', JSON.stringify(this.entries));
                } catch (e) {
                    console.warn('Cannot save error log to localStorage');
                }
                
                console.error('System Error:', entry);
            },
            
            getRecentErrors: function(hours = 24) {
                const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
                return this.entries.filter(entry => new Date(entry.timestamp) > cutoff);
            }
        };

        // Initialize System - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = performance.now();
            
            try {
                console.log('üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2 ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                
                // Initialize system health monitoring
                initializeSystemHealth();
                
                // Setup error handling
                setupGlobalErrorHandling();
                
                // Initialize UI components
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // Create initial data sets with error handling
                try {
                    const container = document.getElementById('dataContainer');
                    if (!container) {
                        throw new Error('Data container not found');
                    }
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á data set ‡πÅ‡∏£‡∏Å
                    const newDataSet = document.createElement('div');
                    newDataSet.innerHTML = generateDataSet(1);
                    const el = newDataSet.firstElementChild;
                    if (el) {
                        container.appendChild(el);
                        console.log('PD2:A appended initial dataset 1');
                    } else {
                        throw new Error('Failed to create initial data set element');
                    }
                    
                    dataSetCount = 1;
                    updateDataSetCount();
                } catch (error) {
                    ERROR_LOG.log(error, 'Initial data set creation');
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                }
                
                // Setup event listeners with error handling
                setupEventListeners();
                setupSelectHandlers();
                try { window.PD2_WAGE_A && window.PD2_WAGE_A.bindWageAForAllSets(); } catch(_){}
                setupNetworkMonitoring();
                
                // Check for pending submissions
                checkForPendingSubmissions();
                
                // Setup auto-save with improved interval
                setupAutoSave();
                
                // Load existing data if available
                loadFromLocalStorage();
                
                // Performance tracking
                const loadTime = performance.now() - startTime;
                SYSTEM_HEALTH.performanceMetrics.loadTime = loadTime;
                console.log(`‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô ${loadTime.toFixed(2)}ms`);
                
                // ‡πÅ‡∏™‡∏î‡∏á notification ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á
                const stored = LS.get('productionData');
                if (stored) {
                    setTimeout(() => {
                        showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    }, 800);
                }
                
            } catch (error) {
                ERROR_LOG.log(error, 'System initialization');
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        });

        // System Health Functions
        function initializeSystemHealth() {
            // Check browser compatibility
            if (!window.localStorage) {
                showNotification('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
            }
            
            // Check available storage
            try {
                const testKey = 'storageTest';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
            } catch (e) {
                showNotification('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏°: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
            }
            
            SYSTEM_HEALTH.isOnline = navigator.onLine;
        }
        
        function setupGlobalErrorHandling() {
            // Handle uncaught errors
            window.addEventListener('error', function(event) {
                ERROR_LOG.log(event.error, `Global error: ${event.filename}:${event.lineno}`);
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
            
            // Handle unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                ERROR_LOG.log(event.reason, 'Unhandled promise rejection');
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
        }
        
        function setupNetworkMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', function() {
                SYSTEM_HEALTH.isOnline = true;
                showNotification('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
                // Try to sync pending data
                checkForPendingSubmissions();
            });
            
            window.addEventListener('offline', function() {
                SYSTEM_HEALTH.isOnline = false;
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', 'warning');
            });
        }
        
        function setupAutoSave() {
            // Clear existing interval if any
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // Auto-save every 3 minutes (reduced from 5 for better reliability)
            autoSaveInterval = setInterval(() => {
                try {
                    saveToLocalStorage();

                } catch (error) {
                    ERROR_LOG.log(error, 'Auto-save failed');
                }
            }, 180000);
            
            // Also save before page unload
            window.addEventListener('beforeunload', function(e) {
                try {
                    saveToLocalStorage();
                } catch (error) {
                    ERROR_LOG.log(error, 'Before unload save failed');
                }
            });
        }

        // Update current time display
        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            } catch (error) {
                ERROR_LOG.log(error, 'Update time failed');
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Prevent accidental page leave
            window.addEventListener('beforeunload', function(e) {
                const hasData = document.querySelectorAll('.data-set').length > 0;
                if (hasData) {
                    e.preventDefault();
                    e.returnValue = '';
                    saveToLocalStorage();
                }
            });

            // Auto-save on input changes
            document.addEventListener('input', function(e) {
                if (e.target.matches('.input-field')) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(saveToLocalStorage, 2000);
                }
            });

            // Realtime WAGE_A updates (delegated, once)
            try {
                if (!document.__PD2_WAGE_A_REALTIME) {
                    const handler = (ev) => {
                        const t = ev && ev.target;
                        if (!t || !t.name) return;
                        const name = String(t.name);
                        // match fields that affect wage calc
                        const match = /^(meterStartA_|meterEndA_|lengthA_|fabricSize_|fabricSizeManual_)/.test(name);
                        if (!match) return;
                        const m = name.match(/_(\d+)$/);
                        const setNumber = m ? m[1] : null;
                        if (!setNumber) return;
                        try { window.PD2_WAGE_A && window.PD2_WAGE_A.updateWageAForSet(setNumber); } catch(_){}
                    };
                    document.addEventListener('input', handler, true);
                    document.addEventListener('change', handler, true);
                    document.__PD2_WAGE_A_REALTIME = true;
                }
            } catch(_){ }
        }

        // Generate Data Set HTML
        function generateDataSet(setNumber) {
            const today = new Date().toISOString().split('T')[0];
            
            return `
                <div class="data-set glass rounded-lg p-6 mb-6" data-set="${setNumber}">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-medium text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <defs>
                                    <linearGradient id="setGrad${setNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect fill="url(#setGrad${setNumber})" x="3" y="4" width="18" height="15" rx="2" ry="2"/>
                                <polyline stroke="white" stroke-width="2" points="16,10 12,14 8,10"/>
                            </svg>
                            ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${setNumber}
                        </h2>
                        ${setNumber > 1 ? `
                            <button onclick="removeDataSet(${setNumber})" class="btn-glow btn-red text-white px-3 py-2 rounded-lg font-normal text-sm flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                ‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        ` : ''}
                    </div>

                    <!-- mobile responsive fix: stack columns on small screens -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="basicGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle fill="url(#basicGrad)" cx="12" cy="12" r="10"/>
                                    <path stroke="white" stroke-width="2" d="m9 12 2 2 4-4"/>
                                </svg>
                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-medium mb-2 text-base">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="date" name="date_${setNumber}" value="${today}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                
                                <div>
                                        <label class="block font-medium mb-2 text-base">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠ NO</label>
                                    <select name="machine_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠</option>
                                        ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                                        <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                                    </select>
                                    <div class="mt-3">
                                        <label class="block font-medium mb-2 text-base">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠ NO (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)</label>
                                        <input type="text" name="machineManual_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô CL96">
                                        <p class="text-xs text-gray-200 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ 2 ‡∏ó‡∏≤‡∏á: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≠ ‡∏Å‡∏∞ A</label>
                                    <select name="employeeA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
                                        ${employees.map(emp => `<option value="${emp.id}">${emp.id} - ${emp.name}</option>`).join('')}
                                        <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                                    </select>
                                    <div class="mt-3">
                                        <label class="block font-medium mb-2 text-base">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≠ ‡∏Å‡∏∞ A (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)</label>
                                        <input type="text" name="employeeAManual_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠">
                                        <p class="text-xs text-gray-200 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ 2 ‡∏ó‡∏≤‡∏á: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base">‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤</label>
                                    <select name="fabricSize_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤</option>
                                        ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                                        <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                                    </select>
                                    <div class="mt-3">
                                        <label class="block font-medium mb-2 text-base">‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤ (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)</label>
                                        <input type="text" name="fabricSizeManual_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤">
                                        <p class="text-xs text-gray-200 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ 2 ‡∏ó‡∏≤‡∏á: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß+‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤) -->
                        <div class="space-y-6">
                            <!-- ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô -->
                            <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                                <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <defs>
                                            <linearGradient id="meterGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                                            </linearGradient>
                                        </defs>
                                        <circle fill="url(#meterGrad)" cx="12" cy="12" r="10"/>
                                        <polyline stroke="white" stroke-width="2" points="12,6 12,12 16,14"/>
                                    </svg>
                                    ‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
                                </h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">‡∏Å‡∏∞ A: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                                        <input type="number" name="meterStartA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 500">
                                    </div>
                                    
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">‡∏Å‡∏∞ A: ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</label>
                                        <input type="number" name="meterEndA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1000">
                                    </div>
                                </div>
                            </div>

                            <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á -->
                            <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                                <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <defs>
                                            <linearGradient id="lengthGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#0891b2;stop-opacity:1" />
                                            </linearGradient>
                                            <filter id="lengthGlow">
                                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                                <feMerge> 
                                                    <feMergeNode in="coloredBlur"/>
                                                    <feMergeNode in="SourceGraphic"/>
                                                </feMerge>
                                            </filter>
                                        </defs>
                                        <circle fill="url(#lengthGrad)" cx="12" cy="12" r="10" filter="url(#lengthGlow)"/>
                                        <path stroke="white" stroke-width="2" d="M8 8h8M8 12h8M8 16h8"/>
                                        <circle fill="white" cx="6" cy="8" r="1"/>
                                        <circle fill="white" cx="6" cy="12" r="1"/>
                                        <circle fill="white" cx="6" cy="16" r="1"/>
                                        <path stroke="white" stroke-width="1.5" d="M18 6v12"/>
                                    </svg>
                                    ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                                </h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô (‡πÄ‡∏°‡∏ï‡∏£)</label>
                                        <input type="number" name="lengthA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2500" step="0.01">
                                    </div>
                                    
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Å‡∏∞ A)</label>
                                        <input type="text" name="wageA_${setNumber}" class="input-field wage-a-input w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" inputmode="decimal" autocomplete="off" readonly>
                                        <p class="text-xs text-red-500 mt-1 hidden" data-wageA-error="${setNumber}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            `;
        }

        // Add Data Set
        function addDataSet() {
            if (dataSetCount >= 100) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 100 ‡∏ä‡∏∏‡∏î', 'error');
                return;
            }
            
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            if (newElement) {
                try {
                    newElement.style.opacity = '0';
                    newElement.style.transition = 'opacity 180ms ease-out';
                    newElement.style.visibility = 'hidden';
                    container.appendChild(newElement);
                    console.log('PD2:A appended new dataset', dataSetCount, newElement);
                    PD2DebugBadge('A: append #' + dataSetCount);
                    requestAnimationFrame(() => {
                        try {
                            newElement.style.visibility = 'visible'; void newElement.offsetWidth; newElement.style.opacity = '1';
                            newElement.scrollIntoView && newElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            const prev = container.style.overflow; container.style.overflow = 'visible';
                            setTimeout(() => { container.style.overflow = prev || ''; }, 300);
                        } catch(_){ }
                        setTimeout(() => {
                            try {
                                if (newElement.offsetHeight < 8 || getComputedStyle(newElement).opacity === '0') {
                                    newElement.style.display = '';
                                    newElement.style.visibility = 'visible';
                                    newElement.style.opacity = '1';
                                    PD2DebugBadge('A: force show #' + dataSetCount);
                                }
                            } catch(_){}
                        }, 300);
                    });
                } catch (e) {
                    container.appendChild(newElement);
                    console.warn('PD2:A append new dataset fallback', e);
                }
            }

            updateDataSetCount();

            // Setup handlers after a short delay to ensure DOM is ready
            setTimeout(() => {
                setupSelectHandlers();
                try { window.PD2_WAGE_A && window.PD2_WAGE_A.bindWageAForAllSets(); } catch(_){}
                showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${dataSetCount} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`, 'green');

                // Scroll to new data set
                if (newElement && typeof newElement.scrollIntoView === 'function') newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Copy and Add Data Set
        function copyAndAddDataSet() {
            if (dataSetCount >= 100) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 100 ‡∏ä‡∏∏‡∏î', 'error');
                return;
            }
            
            const lastDataSet = document.querySelector(`[data-set="${dataSetCount}"]`);
            if (!lastDataSet) {
                addDataSet();
                return;
            }
            
            // Define fields to copy (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            const fieldsToCopy = [
                'date',              // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                'employeeA',         // ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≠ ‡∏Å‡∏∞ A (dropdown)
                'employeeAManual'    // ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≠ ‡∏Å‡∏∞ A (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)
            ];
            
            // Get data from last set (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏)
            const lastData = {};
            const inputs = lastDataSet.querySelectorAll('input, select');
            inputs.forEach(input => {
                const fieldName = input.name.replace(`_${dataSetCount}`, '');
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô fieldsToCopy
                if (fieldsToCopy.includes(fieldName)) {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö date ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏™‡∏°‡∏≠ (‡πÅ‡∏°‡πâ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á), ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö employee ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
                    if (!input.readOnly && !input.disabled) {
                        if (fieldName === 'date' || input.value) {
                            lastData[fieldName] = input.value;
                        }
                    }
                }
            });
            
            // Create new data set
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            if (newElement) {
                try {
                    newElement.style.opacity = '0';
                    newElement.style.transition = 'opacity 180ms ease-out';
                    newElement.style.visibility = 'hidden';
                    container.appendChild(newElement);
                    console.log('PD2:A appended copied dataset', dataSetCount, newElement);
                    PD2DebugBadge('A: append copy #' + dataSetCount);
                    requestAnimationFrame(() => {
                        try {
                            newElement.style.visibility = 'visible'; void newElement.offsetWidth; newElement.style.opacity = '1';
                            newElement.scrollIntoView && newElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            const prev = container.style.overflow; container.style.overflow = 'visible';
                            setTimeout(() => { container.style.overflow = prev || ''; }, 300);
                        } catch(_){ }
                        setTimeout(() => {
                            try {
                                if (newElement.offsetHeight < 8 || getComputedStyle(newElement).opacity === '0') {
                                    newElement.style.display = '';
                                    newElement.style.visibility = 'visible';
                                    newElement.style.opacity = '1';
                                    PD2DebugBadge('A: force show copy #' + dataSetCount);
                                }
                            } catch(_){}
                        }, 300);
                    });
                } catch (e) {
                    container.appendChild(newElement);
                    console.warn('PD2:A append copied dataset fallback', e);
                }
            }

            // Fill with copied data after a short delay to ensure DOM is ready
            setTimeout(() => {
                const newInputs = newElement ? newElement.querySelectorAll('input, select') : [];
                newInputs.forEach(input => {
                    if (!input.readOnly && !input.disabled) {
                        const fieldName = input.name.replace(`_${dataSetCount}`, '');
                        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                        if (lastData[fieldName]) {
                            input.value = lastData[fieldName];
                        }
                    }
                });
                
                // Setup handlers for the new data set
                setupSelectHandlers();
                try { window.PD2_WAGE_A && window.PD2_WAGE_A.bindWageAForAllSets(); } catch(_){}
                
                showNotification(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${dataSetCount} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`, 'blue');
                
                // Scroll to new data set
                if (newElement && typeof newElement.scrollIntoView === 'function') newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);

            updateDataSetCount();
        }

        // Remove Data Set
        function removeDataSet(setNumber) {
            if (dataSetCount <= 1) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏∏‡∏î', 'error');
                return;
            }
            
            const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
            if (dataSet) {
                dataSet.remove();
                dataSetCount--;
                updateDataSetCount();
                showNotification(`‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${setNumber} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`, 'red');
            }
        }

        // Update Data Set Count Display
        function updateDataSetCount() {
            document.getElementById('dataSetCount').textContent = dataSetCount;
        }

        // Setup Select Handlers
    function setupSelectHandlers() {
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', function() {
                    if (this.value === 'ADD_NEW') {
                        const fieldType = this.name.includes('machine') ? 'machine' : 
                                        this.name.includes('employee') ? 'employee' : 'fabric';
                        addNewContext = { type: fieldType, selectName: this.name, setNumber: (this.name.split('_')[1]||'').trim(), selectEl: this };
                        openModal(fieldType);
                        this.value = ''; // Reset select
                        return;
                    }

                    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    try {
                        const setNumber = (this.name.split('_')[1] || '').trim();
                        if (!setNumber) return;

                        if (this.name.startsWith('machine_')) {
                            const manual = document.querySelector(`input[name="machineManual_${setNumber}"]`);
                            if (manual) manual.value = this.value || '';
                        } else if (this.name.startsWith('employeeA_')) {
                            const manual = document.querySelector(`input[name="employeeAManual_${setNumber}"]`);
                            if (manual) {
                                if (this.value) {
                                    const opt = this.options[this.selectedIndex];
                                    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: "ID - Name"
                                    manual.value = opt && opt.text ? opt.text : this.value;
                                } else {
                                    manual.value = '';
                                }
                            }
                        } else if (this.name.startsWith('fabricSize_')) {
                            const manual = document.querySelector(`input[name="fabricSizeManual_${setNumber}"]`);
                            if (manual) manual.value = this.value || '';
                        }
                    } catch(_) {}
                });
            });

            // ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á -> select ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
        document.querySelectorAll('input[name^="employeeAManual_"]').forEach(inp => {
                inp.addEventListener('input', function() {
                    const setNumber = this.name.split('_')[1];
            const sel = document.querySelector(`select[name="employeeA_${setNumber}"]`);
                    const v = (this.value || '').trim();
                    if (!sel) return;
                    // ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ZP9...)
                    const byId = employees.find(e => v.toUpperCase().startsWith(e.id.toUpperCase()));
                    const byPair = employees.find(e => (e.id + ' - ' + e.name) === v);
                    const match = byPair || byId;
                    sel.value = match ? match.id : '';
                });
                // no show/hide toggling
            });

            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠ NO (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á) -> ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà select ‡∏´‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            document.querySelectorAll('input[name^="machineManual_"]').forEach(inp => {
                inp.addEventListener('input', function() {
                    const setNumber = this.name.split('_')[1];
                    const sel = document.querySelector(`select[name="machine_${setNumber}"]`);
                    const v = (this.value || '').trim();
                    if (!sel) return;
                    const up = v.toUpperCase();
                    const found = machines.find(m => m.toUpperCase() === up || m.toUpperCase().startsWith(up));
                    sel.value = found ? found : '';
                });
            });

        document.querySelectorAll('input[name^="fabricSizeManual_"]').forEach(inp => {
                inp.addEventListener('input', function() {
                    const setNumber = this.name.split('_')[1];
            const sel = document.querySelector(`select[name="fabricSize_${setNumber}"]`);
                    const v = (this.value || '').trim();
                    if (!sel) return;
                    const found = fabricSizes.find(s => s.toUpperCase() === v.toUpperCase());
                    sel.value = found ? found : '';
                });
                // no show/hide toggling
            });
            
            // ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (instant suggestions) ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
            try {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: "ID - ‡∏ä‡∏∑‡πà‡∏≠")
                document.querySelectorAll('input[name^="employeeAManual_"]').forEach(inp => {
                    attachInstantSuggestions(inp, () => employees.map(e => ({
                        label: `${e.id} - ${e.name}`,
                        value: `${e.id} - ${e.name}`,
                        key: `${e.id} ${e.name}`.toLowerCase()
                    })));
                });
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠ NO
                document.querySelectorAll('input[name^="machineManual_"]').forEach(inp => {
                    attachInstantSuggestions(inp, () => machines.map(m => ({
                        label: m,
                        value: m,
                        key: m.toLowerCase()
                    })));
                });
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤
                document.querySelectorAll('input[name^="fabricSizeManual_"]').forEach(inp => {
                    attachInstantSuggestions(inp, () => fabricSizes.map(s => ({
                        label: s,
                        value: s,
                        key: s.toLowerCase()
                    })));
                });
            } catch(_) {}
        }
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ datalist ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)
        function attachInstantSuggestions(inputEl, optionsProvider) {
            if (!inputEl || inputEl.dataset.suggestBound) return;
            inputEl.dataset.suggestBound = '1';

            // Guard: ensure any native <select> dropdown gets closed before interacting with our suggestions
            function ensureClosedNativeDropdown() {
                const ae = document.activeElement;
                if (ae && ae.tagName === 'SELECT') {
                    try { ae.blur(); } catch (_) {}
                }
            }

            const panel = document.createElement('div');
            panel.className = 'instant-suggestions hidden';
            Object.assign(panel.style, {
                position: 'fixed',
                zIndex: 9999,
                background: '#ffffff',
                border: '1px solid #d1d5db',
                borderRadius: '0.5rem',
                boxShadow: '0 8px 16px rgba(0,0,0,0.12)',
                maxHeight: '240px',
                overflowY: 'auto',
                minWidth: '200px',
                fontSize: '14px'
            });
            document.body.appendChild(panel);

            let items = [];
            let highlightIndex = -1;
            let visible = false;

            function positionPanel() {
                if (!visible) return;
                const rect = inputEl.getBoundingClientRect();
                panel.style.left = `${Math.round(rect.left)}px`;
                panel.style.top = `${Math.round(rect.bottom + 4)}px`;
                panel.style.width = `${Math.round(rect.width)}px`;
            }

            function showPanel() {
                if (panel.classList.contains('hidden')) panel.classList.remove('hidden');
                visible = true;
                positionPanel();
            }

            function hidePanel() {
                if (!panel.classList.contains('hidden')) panel.classList.add('hidden');
                visible = false;
                highlightIndex = -1;
            }

            function renderList(list) {
                panel.innerHTML = '';
                list.forEach((it, idx) => {
                    const row = document.createElement('div');
                    row.textContent = it.label;
                    Object.assign(row.style, {
                        padding: '8px 12px',
                        cursor: 'pointer',
                        background: idx === highlightIndex ? '#eff6ff' : '#ffffff',
                        color: '#111827'
                    });
                    row.addEventListener('mousemove', () => { highlightIndex = idx; renderList(list); });
                    row.addEventListener('mousedown', (ev) => { ev.preventDefault(); });
                    row.addEventListener('click', () => selectItem(it));
                    panel.appendChild(row);
                });
            }

            function updateList() {
                const q = (inputEl.value || '').toLowerCase();
                const all = (optionsProvider?.() || []);
                const filtered = q ? all.filter(o => o.key.includes(q)) : [];
                items = filtered.slice(0, 50);
                if (items.length > 0 && document.activeElement === inputEl) {
                    showPanel();
                    renderList(items);
                } else {
                    hidePanel();
                }
            }

            function selectItem(item) {
                inputEl.value = item.value;
                // ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô event 'input' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ logic ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
                try { inputEl.dispatchEvent(new Event('input', { bubbles: true })); } catch(_) {}
                hidePanel();
            }

            function onKeyDown(e) {
                if (!visible) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightIndex = Math.min((highlightIndex < 0 ? 0 : highlightIndex + 1), items.length - 1);
                    renderList(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightIndex = Math.max((highlightIndex < 0 ? 0 : highlightIndex - 1), 0);
                    renderList(items);
                } else if (e.key === 'Enter') {
                    if (highlightIndex >= 0 && items[highlightIndex]) {
                        e.preventDefault();
                        selectItem(items[highlightIndex]);
                    }
                } else if (e.key === 'Escape') {
                    hidePanel();
                }
            }

            // Close native select overlay as early as possible when user starts interacting with this input
            inputEl.addEventListener('pointerdown', ensureClosedNativeDropdown, { capture: true });
            inputEl.addEventListener('input', updateList);
            // Keep existing focus behavior; add a separate guard to close any open native select first
            inputEl.addEventListener('focus', ensureClosedNativeDropdown, { capture: true });
            inputEl.addEventListener('focus', updateList);
            inputEl.addEventListener('blur', () => setTimeout(hidePanel, 120));
            inputEl.addEventListener('keydown', onKeyDown);
            window.addEventListener('scroll', positionPanel, true);
            window.addEventListener('resize', positionPanel);
        }
        

        // Modal Functions
        function openModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.remove('hidden');
            
            // Clear previous inputs
            if (type === 'employee') {
                document.getElementById('newEmployeeId').value = '';
                document.getElementById('newEmployeeName').value = '';
            } else {
                document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}${type === 'fabric' ? 'Size' : ''}`).value = '';
            }
        }

                // ===========================
                // Wage (Shift-A) calculation
                // ===========================
                (function(){
                        "use strict";

                        function toNumberSafe(value) {
                            if (value == null) return null;

                            if (typeof value === "number") {
                                return Number.isFinite(value) ? value : null;
                            }

                            if (typeof value === "string") {
                                let s = value.trim();
                                if (s === "") return null;

                                // Convert Thai digits to Arabic
                                s = s.replace(/[\u0E50-\u0E59]/g, (ch) => String(ch.charCodeAt(0) - 0x0E50));
                                // remove commas and spaces
                                s = s.replace(/[\,\s]/g, "");

                                const n = Number(s);
                                return Number.isFinite(n) ? n : null;
                            }

                            return null;
                        }

                        function extractSizeFromRow(row) {
                            const v1 = toNumberSafe(row["‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤ (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)"]);
                            if (v1 != null) return v1;

                            const v2 = toNumberSafe(row["‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤"]);
                            if (v2 != null) return v2;

                            return null;
                        }

                        function extractSizeFromCode(code) {
                            if (!code) return null;
                            code = String(code).toUpperCase();
                            try {
                                // Special-case: any SCL code (case-insensitive) -> take characters at positions 6 and 7 (1-based)
                                if (code.includes("SCL")) {
                                    const part = code.slice(5, 7);
                                    const n = parseInt(part, 10);
                                    return Number.isFinite(n) ? n : null;
                                }

                                if (code.startsWith("FCL")) {
                                    return parseInt(code.slice(5, 7), 10);
                                } else if (code.startsWith("TEST")) {
                                    return parseInt(code.slice(4, 6), 10);
                                } else {
                                    return parseInt(code.slice(0, 2), 10);
                                }
                            } catch (e) {
                                return null;
                            }
                        }

                        function getSize(row) {
                            const sizeNum = extractSizeFromRow(row);
                            if (sizeNum != null && Number.isFinite(sizeNum)) return sizeNum;

                            const codeFields = ["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πâ‡∏≤", "‡πÇ‡∏Ñ‡πâ‡∏î", "code", "Code", "ITEM CODE"];
                            for (const k of codeFields) {
                                if (k in row) {
                                    const sz = extractSizeFromCode(row[k]);
                                    if (Number.isFinite(sz)) return sz;
                                }
                            }

                            return null;
                        }

                        function getRate(size) {
                            if (!size) return 0;
                            if (size >= 12 && size <= 17) return 0.13;
                            if (size >= 18 && size <= 22) return 0.14;
                            if (size >= 23 && size <= 25) return 0.15;
                            if (size >= 26 && size <= 30) return 0.18;
                            return 0;
                        }

                        function calcOutputA(row) {
                            const start = toNumberSafe(row["‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏Å‡∏∞ A: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô"]);
                            const end = toNumberSafe(row["‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏Å‡∏∞ A: ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô"]);
                            const cutLen = toNumberSafe(row["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô (‡πÄ‡∏°‡∏ï‡∏£) ‡∏Å‡∏∞ A"]);

                            if (start == null || end == null) return null;

                            if (start <= end) {
                                return Math.max(0, end - start);
                            }

                            // reset case
                            if (cutLen != null) {
                                const diff = start - end;
                                return Math.max(0, cutLen - diff);
                            }

                            return null;
                        }

                        function calculateWageA(row) {
                            const size = getSize(row);
                            const outputA = calcOutputA(row);
                            if (outputA == null) return null;

                            const rate = getRate(size);
                            const unit = rate > 0 ? rate : (Number.isFinite(size) ? size : 0);

                            const wage = outputA * unit;
                            return Number(wage.toFixed(2));
                        }

                                    function buildRowForSet(setNumber) {
                                        const qs = (sel) => document.querySelector(sel);
                                        const fabSel = qs(`[name="fabricSize_${setNumber}"]`)?.value || "";
                                        const fabManual = qs(`[name="fabricSizeManual_${setNumber}"]`)?.value || "";
                                        const row = {
                                            "‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤": "",
                                            "‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤ (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)": "",
                                            "‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏Å‡∏∞ A: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô": qs(`[name="meterStartA_${setNumber}"]`)?.value || "",
                                            "‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏Å‡∏∞ A: ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô": qs(`[name="meterEndA_${setNumber}"]`)?.value || "",
                                            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô (‡πÄ‡∏°‡∏ï‡∏£) ‡∏Å‡∏∞ A": qs(`[name="lengthA_${setNumber}"]`)?.value || ""
                                        };
                                        // Determine size source
                                        if (fabManual) {
                                            const n = toNumberSafe(fabManual);
                                            if (n != null && n <= 100) {
                                                row["‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤ (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)"] = String(n);
                                            } else {
                                                row["‡πÇ‡∏Ñ‡πâ‡∏î"] = fabManual;
                                            }
                                        } else if (fabSel) {
                                            row["‡πÇ‡∏Ñ‡πâ‡∏î"] = fabSel;
                                        }
                                        return row;
                                    }

                        function showWageError(setNumber, msg) {
                            try {
                                const p = document.querySelector(`[data-wageA-error="${setNumber}"]`);
                                if (!p) return;
                                if (msg) {
                                    p.textContent = msg;
                                    p.classList.remove('hidden');
                                } else {
                                    p.textContent = '';
                                    p.classList.add('hidden');
                                }
                            } catch(_) {}
                        }

                        function updateWageAForSet(setNumber) {
                            try {
                                const input = document.querySelector(`[name="wageA_${setNumber}"]`);
                                if (!input) return;
                                const row = buildRowForSet(setNumber);
                                const val = calculateWageA(row);
                                if (val == null) {
                                    input.value = '';
                                    input.classList.remove('valid');
                                    showWageError(setNumber, '');
                                } else {
                                    input.value = Number(val).toFixed(2);
                                    input.classList.add('valid');
                                    showWageError(setNumber, '');
                                }
                            } catch (e) {
                                console.warn('Wage update failed:', e);
                            }
                        }

                        function bindWageAListenersForSet(setNumber) {
                            const sel = (n) => document.querySelector(`[name="${n}_${setNumber}"]`);
                            const fields = [
                                'meterStartA', 'meterEndA', 'lengthA'
                            ];
                            fields.forEach(fn => {
                                const el = sel(fn);
                                if (el && !el.dataset.wageBound) {
                                    el.dataset.wageBound = '1';
                                    el.addEventListener('input', () => updateWageAForSet(setNumber));
                                    el.addEventListener('change', () => updateWageAForSet(setNumber));
                                }
                            });
                            // fabric size select + manual
                            ['fabricSize', 'fabricSizeManual'].forEach(fn => {
                                const el = sel(fn);
                                if (el && !el.dataset.wageBound) {
                                    el.dataset.wageBound = '1';
                                    el.addEventListener('input', () => updateWageAForSet(setNumber));
                                    el.addEventListener('change', () => updateWageAForSet(setNumber));
                                }
                            });

                            // wageA is computed only; disable direct user edits (readonly input)
                            // self-edit handlers intentionally removed to prevent user override

                            // Initial compute
                            updateWageAForSet(setNumber);
                        }

                        function bindWageAForAllSets() {
                            document.querySelectorAll('.data-set').forEach(ds => {
                                const setNumber = ds.getAttribute('data-set');
                                if (setNumber) bindWageAListenersForSet(setNumber);
                            });
                        }

                        // Expose minimal APIs to outer scope
                        window.PD2_WAGE_A = {
                            toNumberSafe,
                            extractSizeFromRow,
                            extractSizeFromCode,
                            getSize,
                            getRate,
                            calcOutputA,
                            calculateWageA,
                            updateWageAForSet,
                            bindWageAForAllSets
                        };
                })();

        function closeModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.add('hidden');
        }

        // Success Modal with Auto-Reset Countdown
        let countdownInterval = null;
        let countdownSeconds = 90;

        function showSuccessModal(totalRows) {
            const modal = document.getElementById('successModal');
            const countElement = document.getElementById('successModalCount');
            const timerElement = document.getElementById('countdownTimer');
            
            if (countElement) countElement.textContent = totalRows;
            if (modal) modal.classList.remove('hidden');
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏° countdown
            countdownSeconds = 90;
            if (timerElement) timerElement.textContent = countdownSeconds;
            
            // Clear interval ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏° countdown timer
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                if (timerElement) timerElement.textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    continueWithSameEmployee(); // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
                }
            }, 1000);
            
            console.log('‚úÖ Success modal shown with', totalRows, 'rows');
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            if (modal) modal.classList.add('hidden');
            
            // Clear countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function continueWithSameEmployee() {
            console.log('üîÑ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠');
            closeSuccessModal();
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reset ‡∏≠‡∏∞‡πÑ‡∏£ - ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ
            showNotification('‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ', 'blue');
        }

        function resetForNextEmployee() {
            console.log('‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ');
            closeSuccessModal();
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            try {
                resetToSingleDataSet();
                showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'green');
            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ reset:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Fallback showNotification if not available from parent
        if (typeof showNotification === 'undefined') {
            window.showNotification = function(message, type) {
                console.log('[Notification]', type, ':', message);
                // Try parent window notification
                try {
                    if (window.parent && window.parent !== window && window.parent.PD2Notify) {
                        window.parent.PD2Notify(message, type);
                    } else {
                        alert(message);
                    }
                } catch (e) {
                    alert(message);
                }
            };
        }

    function saveModalData(type) {
            let newValue = '';
            let isValid = false;

            if (type === 'employee') {
                const id = document.getElementById('newEmployeeId').value.trim();
                const name = document.getElementById('newEmployeeName').value.trim();
                if (id && name) {
                    newValue = id;
                    if (!employees.some(e => e.id === id)) {
                        employees.push({ id: id, name: name });
                    }
                    isValid = true;
                }
            } else if (type === 'machine') {
                newValue = document.getElementById('newMachine').value.trim();
                if (newValue) {
                    if (!machines.includes(newValue)) {
                        machines.push(newValue);
                    }
                    isValid = true;
                }
            } else if (type === 'fabric') {
                newValue = document.getElementById('newFabricSize').value.trim();
                if (newValue) {
                    if (!fabricSizes.includes(newValue)) {
                        fabricSizes.push(newValue);
                    }
                    isValid = true;
                }
            }

            if (isValid) {
                try {
                    if (window.parent && window.parent !== window) {
                        if (type === 'employee') {
                            const emp = employees.find(e => e.id === newValue);
                            window.parent.postMessage({ type: 'PD2_ADD_CUSTOM', category: 'employee', data: { id: emp.id, name: emp.name } }, '*');
                        } else if (type === 'machine') {
                            window.parent.postMessage({ type: 'PD2_ADD_CUSTOM', category: 'machine', data: { value: newValue } }, '*');
                        } else if (type === 'fabric') {
                            window.parent.postMessage({ type: 'PD2_ADD_CUSTOM', category: 'fabric', data: { value: newValue } }, '*');
                        }
                    }
                } catch(_) {}

                const originName = (addNewContext && addNewContext.type === type) ? addNewContext.selectName : null;
                updateAllSelects(type, newValue, originName);
                addNewContext = null;
                closeModal(type);
                showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } else {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        }

        function updateAllSelects(type, newValue, originSelectName) {
            const query = `select[name*="${type === 'employee' ? 'employee' : type === 'fabric' ? 'fabricSize' : 'machine'}"]`;
            const selects = document.querySelectorAll(query);

            selects.forEach(select => {
                const isOrigin = (originSelectName && select.name === originSelectName);
                const prevValue = select.value;
                // Remove old ADD_NEW option
                const addNewOption = select.querySelector('option[value="ADD_NEW"]');
                if (addNewOption) addNewOption.remove();

                // Add new option only if not exists
                let exists = Array.from(select.options).some(o => o.value === newValue);
                if (!exists) {
                    const opt = document.createElement('option');
                    if (type === 'employee') {
                        const emp = employees.find(e => e.id === newValue);
                        opt.value = newValue;
                        opt.textContent = emp ? `${emp.id} - ${emp.name}` : newValue;
                    } else {
                        opt.value = newValue;
                        opt.textContent = newValue;
                    }
                    select.appendChild(opt);
                }

                // Re-add ADD_NEW option
                const addOpt = document.createElement('option');
                addOpt.value = 'ADD_NEW';
                addOpt.textContent = '‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà';
                select.appendChild(addOpt);

                // Restore selection; select new only for origin
                if (isOrigin) {
                    select.value = newValue;
                    if (type === 'fabric') {
                        const setNumber = select.name.split('_')[1];
                        const manual = document.querySelector(`[name="fabricSizeManual_${setNumber}"]`);
                        if (manual) manual.value = newValue;
                    }
                } else {
                    select.value = prevValue === 'ADD_NEW' ? '' : prevValue;
                }
            });

            // Update datalists to reflect new options
            refreshAllDatalists();
        }

        // Refresh All Selects
        function refreshAllSelects() {
            // Refresh machine selects
            document.querySelectorAll('select[name*="machine"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠</option>
                    ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                    <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                `;
                select.value = currentValue;
            });
            
            // Refresh employee selects
            document.querySelectorAll('select[name*="employee"]').forEach(select => {
                if (!select.name.includes('employeeB')) {
                    const currentValue = select.value;
                    select.innerHTML = `
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
                        ${employees.map(emp => `<option value="${emp.id}">${emp.id} - ${emp.name}</option>`).join('')}
                        <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                    `;
                    select.value = currentValue;
                }
            });
            
            // Refresh fabric selects
            document.querySelectorAll('select[name*="fabricSize"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤</option>
                    ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                    <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                `;
                select.value = currentValue;
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï datalist ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            refreshAllDatalists();
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô datalist ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏° master arrays ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        function refreshAllDatalists() {
            // ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            document.querySelectorAll('datalist[id^="employeeList_"]').forEach(dl => {
                const html = employees.map(emp => `<option value="${emp.id} - ${emp.name}"></option>`).join('');
                dl.innerHTML = html;
            });
            // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤
            document.querySelectorAll('datalist[id^="fabricSizeList_"]').forEach(dl => {
                const html = fabricSizes.map(size => `<option value="${size}"></option>`).join('');
                dl.innerHTML = html;
            });
        }

        // Sync shared lists from parent (session-only)
        function mergeSharedLists(shared) {
            if (!shared) return;
            // machines
            (shared.machines||[]).forEach(m => { if (!machines.includes(m)) machines.push(m); });
            // fabricSizes
            (shared.fabricSizes||[]).forEach(f => { if (!fabricSizes.includes(f)) fabricSizes.push(f); });
            // employees
            (shared.employees||[]).forEach(emp => { if (!employees.some(e => e.id === emp.id)) employees.push(emp); });
            // refresh UI
            try { refreshAllSelects(); } catch(_) {}
        }

        // request sync on load
        try {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'PD2_REQUEST_SYNC' }, '*');
            }
        } catch(_) {}

        // listen for sync payloads
        window.addEventListener('message', (ev) => {
            const m = ev?.data;
            if (m && m.type === 'PD2_SYNC_CUSTOM') {
                mergeSharedLists(m.payload);
            }
        });

        // Data Submission Functions
        async function submitData() {
            console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            
            const allData = collectAllData();
            if (!allData || allData.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                return;
            }
            
            // Save data for recovery before submission
            saveDataForRecovery(allData);
            
            showLoading();
            updateProgressStep(1);
            updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            const payload = {
                action: 'saveData',
                data: {
                    title: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏∞ A",
                    timestamp: new Date().toISOString(),
                    totalSets: allData.length,
                    data: allData
                },
                sheetId: API_CONFIG.sheetId,
                folderId: API_CONFIG.folderId,
                timestamp: new Date().toISOString()
            };
            
            try {
                await submitWithRetry(payload, 3, 1);
            } catch (error) {
                console.error('‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
                hideLoading();
                showNotification('‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        }

    // Small helpers to ensure UI can repaint between async steps
    const __delay = (ms = 300) => new Promise(res => setTimeout(res, ms));
    const __nextFrame = () => new Promise(res => requestAnimationFrame(() => res()));

    const PD2_SUBMIT_CFG = {
        minStep5VisibleMs: 90,
        preSendPaintMs: 50,
        attemptTimeoutMs: 10000,
        baseBackoffMs: 450,
        backoffFactor: 2,
        jitterMs: 150
    };
    if (!window.PD2PerfLog) window.PD2PerfLog = [];
    const perfStartA = () => performance.now();
    async function submitWithRetry(data, maxRetries, currentAttempt, useBackup = false, t0) {
            if (!t0) t0 = perfStartA();
            const mark = (phase, extra) => { try { window.PD2PerfLog.push({ module:'SHIFT_A', phase, t: performance.now(), dt:+(performance.now()-t0).toFixed(1), ...(extra||{}) }); } catch(_){} };
            mark('attempt_'+currentAttempt);
            console.log(`üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttempt}/${maxRetries}${useBackup ? ' (‡πÉ‡∏ä‡πâ backup)' : ''}`);
            updateProgressStep(2); updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            if (!SYSTEM_HEALTH.isOnline) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
            await new Promise(r => setTimeout(r, 60));
            updateProgressStep(3); updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...');
            let endpoint = API_CONFIG.endpoint;
            if (useBackup && API_CONFIG.backupEndpoints.length > 0) {
                const backupIndex = (currentAttempt - 1) % API_CONFIG.backupEndpoints.length;
                endpoint = API_CONFIG.backupEndpoints[backupIndex];
                console.log(`üîÑ ‡πÉ‡∏ä‡πâ backup endpoint: ${endpoint}`);
            }
            try {
                const submissionId = (self.crypto && crypto.randomUUID ? crypto.randomUUID() : 'sub-' + Date.now() + '-' + Math.random().toString(16).slice(2));
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), PD2_SUBMIT_CFG.attemptTimeoutMs);
                const payload = { ...data, submissionId, systemInfo: { userAgent: navigator.userAgent, timestamp: new Date().toISOString(), attempt: currentAttempt, endpoint } };
        updateProgressStep(4); updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        await new Promise(r => setTimeout(r, PD2_SUBMIT_CFG.preSendPaintMs));
        mark('send');
        // Simple request (‡∏´‡∏•‡∏ö preflight)
        const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), signal: controller.signal, cache: 'no-store', keepalive: true });
        clearTimeout(timeoutId);
                let ok = response.ok; let txt=''; let json=null;
                try { txt = await response.text(); if (txt) { try { json = JSON.parse(txt); } catch(_){} } } catch(_){}
                const logicalSuccess = json && (json.success === true || json.status === 'ok');
                if (!ok || !logicalSuccess) {
                    const pending = { savedAt: new Date().toISOString(), submissionId, endpoint, httpStatus: response.status, ok, logicalSuccess, bodySample: (txt||'').slice(0,500), payload };
                    LS.set('pendingSubmission', JSON.stringify(pending));
                    throw new Error('‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß HTTP:' + response.status + ' successFlag:' + logicalSuccess);
                }
        updateProgressStep(5); updateLoadingStatus('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        mark('step5');
        const s5At = performance.now();
        const need = PD2_SUBMIT_CFG.minStep5VisibleMs - (performance.now() - s5At);
        if (need > 10) await new Promise(r => setTimeout(r, need));
                LS.remove('pendingSubmission');
                SYSTEM_HEALTH.saveFailureCount = 0; SYSTEM_HEALTH.lastSaveTime = new Date();
                const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                hideLoading();
                showSuccessModal(totalRows);
                console.log('‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', { submissionId, totalRows, response: json });
            } catch (error) {
                const isLikelyCors = (error instanceof TypeError) || /fetch|network|cors/i.test(error.message || '');
                if (currentAttempt === 1 && isLikelyCors) {
                    try {
                        console.warn('‚ö†Ô∏è Simple POST ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î CORS -> ‡∏•‡∏≠‡∏á JSONP');
                        const jsonpResult = await jsonpFallback(data, endpoint);
                        if (jsonpResult && jsonpResult.success) {
                            const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                updateProgressStep(5); updateLoadingStatus('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
                const s5At2 = performance.now();
                const need2 = PD2_SUBMIT_CFG.minStep5VisibleMs - (performance.now() - s5At2);
                if (need2 > 10) await new Promise(r => setTimeout(r, need2));
                            hideLoading();
                            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î '+ totalRows +' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'orange');
                            SYSTEM_HEALTH.saveFailureCount = 0; LS.remove('pendingSubmission');
                            return;
                        }
                    } catch (jsonpErr) { console.error('‚ùå JSONP fallback ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', jsonpErr); }
                }
                console.error(`‚ùå ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttempt} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, error);
                ERROR_LOG.log(error, `Submit attempt ${currentAttempt}`); SYSTEM_HEALTH.saveFailureCount++;
                if (currentAttempt < maxRetries) {
                    updateLoadingStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà... (${currentAttempt + 1}/${maxRetries})`);
                    const base = PD2_SUBMIT_CFG.baseBackoffMs * Math.pow(PD2_SUBMIT_CFG.backoffFactor, currentAttempt - 1);
                    const jitter = Math.random() * PD2_SUBMIT_CFG.jitterMs;
                    const delay = Math.min(base + jitter, 5000);
                    await new Promise(r => setTimeout(r, delay));
                    const shouldUseBackup = currentAttempt >= 2; return submitWithRetry(data, maxRetries, currentAttempt + 1, shouldUseBackup, t0);
                } else {
                    if (SYSTEM_HEALTH.saveFailureCount >= SYSTEM_HEALTH.maxFailures) showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÜ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                    try { if (LS.get('pendingSubmission')) showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡πÑ‡∏î‡πâ: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning'); } catch(_){}
                    throw error;
                }
            }
        }

        // JSONP fallback helper
        function jsonpFallback(originalPayload, endpoint) {
            return new Promise((resolve, reject) => {
                try {
                    if (!originalPayload || originalPayload.action !== 'saveData') return reject(new Error('JSONP ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ saveData'));
                    const minimal = { action: 'saveData', data: originalPayload.data };
                    const jsonStr = JSON.stringify(minimal);
                    const encoded = encodeURIComponent(jsonStr);
                    if (encoded.length > 7000) return reject(new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JSONP'));
                    const cbName = '__jsonpCB_' + Date.now() + '_' + Math.random().toString(16).slice(2);
                    const url = endpoint + '?action=saveData&data=' + encoded + '&callback=' + cbName;
                    const script = document.createElement('script');
                    let timeoutId;
                    window[cbName] = function(resp){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); resolve(resp); };
                    script.onerror = function(){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP script load error')); };
                    timeoutId = setTimeout(() => { try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP timeout')); }, 15000);
                    script.src = url; document.head.appendChild(script);
                } catch(err) { reject(err); }
            });
        }

        // Collect All Data
    function collectAllData() {
            const allData = [];
            const dataSets = document.querySelectorAll('.data-set');
            
            dataSets.forEach((dataSet, index) => {
                const setNumber = (dataSet.getAttribute('data-set') || (index + 1)).toString();
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠: ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
        const machSelVal = dataSet.querySelector(`[name="machine_${setNumber}"]`)?.value || '';
        const machManualVal = dataSet.querySelector(`[name="machineManual_${setNumber}"]`)?.value || '';
        const machineValue = machManualVal ? machManualVal.trim() : machSelVal;
                // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ‡∏´‡∏≤‡∏Å‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô select
                const empSelVal = dataSet.querySelector(`[name="employeeA_${setNumber}"]`)?.value || '';
                const empManualVal = dataSet.querySelector(`[name="employeeAManual_${setNumber}"]`)?.value || '';
                // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô id; ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö "ID - ‡∏ä‡∏∑‡πà‡∏≠" ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏Å‡πÄ‡∏≠‡∏≤ id ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                let employeeAValue = empSelVal;
                if (empManualVal) {
                    const idFromManual = empManualVal.split(' - ')[0].trim();
                    employeeAValue = idFromManual || empManualVal.trim();
                }

                const fabSelVal = dataSet.querySelector(`[name="fabricSize_${setNumber}"]`)?.value || '';
                const fabManualVal = dataSet.querySelector(`[name="fabricSizeManual_${setNumber}"]`)?.value || '';
                const fabricSizeValue = fabManualVal ? fabManualVal.trim() : fabSelVal;
                const setData = {
                    setNumber: Number(setNumber),
                    date: dataSet.querySelector(`[name="date_${setNumber}"]`)?.value || '',
                    machine: machineValue,
                    employeeA: employeeAValue,
                    fabricSize: fabricSizeValue,
                    lotNo: dataSet.querySelector(`[name="lotNo_${setNumber}"]`)?.value || '',
                    orderNo: dataSet.querySelector(`[name="orderNo_${setNumber}"]`)?.value || '',
                    productionA: dataSet.querySelector(`[name="productionA_${setNumber}"]`)?.value || '',
                    speedA: dataSet.querySelector(`[name="speedA_${setNumber}"]`)?.value || '',
                    efficiencyA: dataSet.querySelector(`[name="efficiencyA_${setNumber}"]`)?.value || '',
                    meterStartA: dataSet.querySelector(`[name="meterStartA_${setNumber}"]`)?.value || '',
                    meterEndA: dataSet.querySelector(`[name="meterEndA_${setNumber}"]`)?.value || '',
                    lengthA: dataSet.querySelector(`[name="lengthA_${setNumber}"]`)?.value || '',
                    wageA: dataSet.querySelector(`[name="wageA_${setNumber}"]`)?.value || ''
                };
                
                allData.push(setData);
            });
            
            return allData;
        }

        // PNG Export (Shift A only): Renders selected fields from all data sets to a single image
        function exportPNG() {
            try {
                const data = collectAllData();
                if (!data || data.length === 0) {
                    try { showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'warning'); } catch(_) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); }
                    return;
                }

                // Prepare text lines
                const now = new Date();
                const headerTitle = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏∞ A - ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2';
                const headerTime = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + now.toLocaleString('th-TH');
                const headerCount = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + data.length;
                const rawLines = [headerTitle, headerTime, headerCount, ''];

                data.forEach((set, idx) => {
                    rawLines.push('‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ' + (idx + 1));
                    rawLines.push('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + (set.date || ''));
                    rawLines.push('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠ NO: ' + (set.machine || ''));
                    rawLines.push('‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≠ ‡∏Å‡∏∞ A: ' + (set.employeeA || ''));
                    rawLines.push('‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤: ' + (set.fabricSize || ''));
                    rawLines.push('‡∏Å‡∏∞ A: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: ' + (set.meterStartA || ''));
                    rawLines.push('‡∏Å‡∏∞ A: ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô: ' + (set.meterEndA || ''));
                    rawLines.push('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô (‡πÄ‡∏°‡∏ï‡∏£): ' + (set.lengthA || ''));
                    rawLines.push('‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Å‡∏∞ A): ' + (set.wageA || ''));
                    rawLines.push('');
                });

                // Canvas sizing and wrapping
                const padding = 32; // px
                const width = 1080;  // px (suitable for mobile viewing and printing)
                const fontSize = 28; // px
                const lineHeight = Math.round(fontSize * 1.4);
                const fontFamily = "Kanit, Tahoma, sans-serif";

                // Create measurement context
                const measureCanvas = document.createElement('canvas');
                const mctx = measureCanvas.getContext('2d');
                mctx.font = `${fontSize}px ${fontFamily}`;
                const maxTextWidth = width - padding * 2;

                const wrapText = (text) => {
                    const words = (text || '').toString().split(/\s+/);
                    const lines = [];
                    let line = '';
                    for (let i = 0; i < words.length; i++) {
                        const testLine = line ? (line + ' ' + words[i]) : words[i];
                        const metrics = mctx.measureText(testLine);
                        if (metrics.width > maxTextWidth && line) {
                            lines.push(line);
                            line = words[i];
                        } else {
                            line = testLine;
                        }
                    }
                    if (line) lines.push(line);
                    // Handle extremely long tokens without spaces
                    for (let i = 0; i < lines.length; i++) {
                        if (mctx.measureText(lines[i]).width > maxTextWidth) {
                            const broken = [];
                            let current = lines[i];
                            while (mctx.measureText(current).width > maxTextWidth && current.length > 1) {
                                let lo = 1, hi = current.length, cut = 1;
                                while (lo <= hi) {
                                    const mid = (lo + hi) >> 1;
                                    const substr = current.slice(0, mid);
                                    if (mctx.measureText(substr).width <= maxTextWidth) { cut = mid; lo = mid + 1; } else { hi = mid - 1; }
                                }
                                broken.push(current.slice(0, cut));
                                current = current.slice(cut);
                            }
                            if (current) broken.push(current);
                            lines.splice(i, 1, ...broken);
                            i += broken.length - 1;
                        }
                    }
                    return lines;
                };

                // Build final wrapped lines
                const finalLines = [];
                rawLines.forEach(line => {
                    const wrapped = wrapText(line);
                    if (wrapped.length === 0) finalLines.push('');
                    else finalLines.push(...wrapped);
                });

                const height = padding * 2 + finalLines.length * lineHeight;
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = Math.max(height, padding * 2 + lineHeight);
                const ctx = canvas.getContext('2d');

                // Background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Text
                ctx.fillStyle = '#111827'; // gray-900
                ctx.font = `${fontSize}px ${fontFamily}`;
                ctx.textBaseline = 'top';

                let y = padding;
                const x = padding;
                finalLines.forEach((ln, i) => {
                    // Make section headers slightly bolder by re-setting font for lines starting with '‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà'
                    if (/^‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà\s+\d+/.test(ln)) {
                        ctx.font = `bold ${fontSize}px ${fontFamily}`;
                    } else if (i <= 2) { // title + meta rows
                        ctx.font = `600 ${fontSize}px ${fontFamily}`;
                    } else {
                        ctx.font = `${fontSize}px ${fontFamily}`;
                    }
                    ctx.fillText(ln, x, y);
                    y += lineHeight;
                });

                // Download
                const pad = (n) => (n < 10 ? '0' + n : '' + n);
                const yyyy = now.getFullYear();
                const mm = pad(now.getMonth() + 1);
                const dd = pad(now.getDate());
                const hh = pad(now.getHours());
                const mi = pad(now.getMinutes());
                const ss = pad(now.getSeconds());
                const filename = `PD2_ShiftA_${yyyy}${mm}${dd}_${hh}${mi}${ss}.png`;

                // Use blob-based save to avoid any navigation/new tabs
                canvas.toBlob(async (blob) => {
                    if (!blob) { try { showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PNG ‡πÑ‡∏î‡πâ', 'error'); } catch(_) {}; return; }

                    // 1) File System Access API (Chrome/Edge/Android)
                    if (window.showSaveFilePicker) {
                        try {
                            const handle = await window.showSaveFilePicker({
                                suggestedName: filename,
                                types: [{ description: 'PNG Image', accept: { 'image/png': ['.png'] } }]
                            });
                            const writable = await handle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            try { showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'blue'); } catch(_) {}
                            return;
                        } catch (_) { /* user canceled or unsupported; continue */ }
                    }

                    // 2) Web Share API with files (mobile friendly)
                    try {
                        const file = new File([blob], filename, { type: 'image/png' });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({ files: [file], title: 'PD2 Export', text: 'PD2 Shift A' });
                            try { showNotification('‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'blue'); } catch(_) {}
                            return;
                        }
                    } catch(_) { /* ignore */ }

                    // 3) Anchor download with object URL (same tab)
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.target = '_self';
                    a.rel = 'noopener';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1500);
                }, 'image/png');

                try { showNotification('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î', 'blue'); } catch(_) {}
            } catch (err) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PNG ‡πÑ‡∏î‡πâ:', err);
                try { showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PNG ‡πÑ‡∏î‡πâ', 'error'); } catch(_) { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PNG ‡πÑ‡∏î‡πâ'); }
            }
        }

        // Storage namespace helper (safe for combined UI)
        const SHIFT_ID = 'A';
        const LS = {
            _p: function(k){ return `PD2_SHIFT_${SHIFT_ID}_${k}`; },
            get: function(k){ try { return localStorage.getItem(this._p(k)); } catch(e){ return null; } },
            set: function(k,v){ try { localStorage.setItem(this._p(k), v); } catch(e){} },
            remove: function(k){ try { localStorage.removeItem(this._p(k)); } catch(e){} }
        };

        // Listen for parent frame commands when embedded
        try {
            window.addEventListener('message', function(ev){
                var msg = ev && ev.data;
                if (!msg || msg.shift && msg.shift !== SHIFT_ID) return; // ignore others
                if (msg && msg.cmd === 'save') { saveToLocalStorage(true); window.parent.postMessage({shift:SHIFT_ID, event:'saved'}, '*'); }
                if (msg && msg.cmd === 'load') { loadFromLocalStorage(); window.parent.postMessage({shift:SHIFT_ID, event:'loaded'}, '*'); }
                if (msg && msg.cmd === 'clear') { clearLocalStorage(); window.parent.postMessage({shift:SHIFT_ID, event:'cleared'}, '*'); }
            }, false);
        } catch(e){}

        // Storage Functions - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
        function saveToLocalStorage() {
            const saveStartTime = performance.now();
            
            try {
                const allData = collectAllData();
                
                // Validate data before saving
                if (!allData || allData.length === 0) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                    return;
                }
                
                const storageData = {
                    version: '2.0', // ‡πÄ‡∏û‡∏¥‡πà‡∏° version tracking
                    timestamp: new Date().toISOString(),
                    dataSetCount: dataSetCount,
                    data: allData,
                    // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ï‡πà‡∏≠ session ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    // custom lists removed by request
                    systemHealth: {
                        saveTime: saveStartTime,
                        errorCount: SYSTEM_HEALTH.performanceMetrics.errorCount,
                        lastSaveTime: SYSTEM_HEALTH.lastSaveTime
                    }
                };
                
                // Check storage size before saving
                const dataSize = JSON.stringify(storageData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB limit
                
                if (dataSize > maxSize) {
                    // Clean old data if size is too large
                    cleanOldStorageData();
                }
                
                // Create backup before overwriting (namespaced)
                const existingData = LS.get('productionData');
                if (existingData) {
                    LS.set('productionDataBackup', existingData);
                }
                
                LS.set('productionData', JSON.stringify(storageData));
                
                const saveTime = performance.now() - saveStartTime;
                SYSTEM_HEALTH.performanceMetrics.saveTime = saveTime;
                SYSTEM_HEALTH.lastSaveTime = new Date();
                
                console.log(`üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß (${saveTime.toFixed(2)}ms, ${(dataSize/1024).toFixed(2)}KB)`);
                
                // Only show notification if manually triggered
                if (arguments.length > 0 && arguments[0] === true) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'purple');
                }
                
            } catch (error) {
                ERROR_LOG.log(error, 'Save to localStorage failed');
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', error);
                
                // Try to recover from backup
                if (error.name === 'QuotaExceededError') {
                    showNotification('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏°: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤...', 'warning');
                    cleanOldStorageData();
                    
                    // Try saving again
                    try {
                        LS.set('productionData', JSON.stringify(storageData));
                        showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    } catch (retryError) {
                        showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                    }
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                }
            }
        }
        
        function cleanOldStorageData() {
            try {
                // Remove old error logs (namespaced)
                const errorLog = LS.get('errorLog');
                if (errorLog) {
                    const logs = JSON.parse(errorLog);
                    const recentLogs = logs.slice(0, 50); // Keep only 50 recent entries
                    LS.set('errorLog', JSON.stringify(recentLogs));
                }
                
                // Remove old backup data
                LS.remove('productionDataBackup');
                
                // Remove other temporary data (global keys still checked)
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('temp_') || key.startsWith('old_') || key.includes('_PD2_SHIFT_A_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                console.log(`üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß (${keysToRemove.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                
            } catch (error) {
                ERROR_LOG.log(error, 'Clean old storage data failed');
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = LS.get('productionData');
                if (!stored) {
                    console.log('‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ');
                    return;
                }
                
                const storageData = JSON.parse(stored);
                
                // ‡πÑ‡∏°‡πà‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                
                // Clear existing data sets
                document.getElementById('dataContainer').innerHTML = '';
                
                // Restore data sets
                dataSetCount = storageData.dataSetCount || 1;
                for (let i = 1; i <= dataSetCount; i++) {
                    const container = document.getElementById('dataContainer');
                    const newDataSet = document.createElement('div');
                    newDataSet.innerHTML = generateDataSet(i);
                    const child = newDataSet.firstElementChild;
                    if (child) {
                        container.appendChild(child);
                        // Force visible in case of mobile rendering quirks
                        try {
                            child.style.display = '';
                            child.style.opacity = '';
                            child.classList.remove('hidden','invisible');
                            child.removeAttribute('hidden');
                        } catch (_) {}
                        // Ensure browser paints and animation runs: toggle class to re-trigger CSS
                        requestAnimationFrame(() => {
                            try {
                                child.classList.remove('data-set');
                                // force reflow
                                void child.offsetWidth;
                                child.classList.add('data-set');
                                child.style.transform = 'none';
                                child.style.opacity = '1';
                                child.style.visibility = 'visible';
                                child.style.zIndex = '10';
                                // temporarily allow overflow to avoid clipping during initial paint
                                try { const prev = container.style.overflow; container.style.overflow = 'visible'; setTimeout(() => { container.style.overflow = prev || ''; }, 300); } catch(_){}
                            } catch(_){}
                        });
                    }
                }
                
                // Fill data
                if (storageData.data) {
                    storageData.data.forEach((setData, index) => {
                        const setNumber = index + 1;
                        const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
                        if (dataSet) {
                            Object.keys(setData).forEach(key => {
                                if (key !== 'setNumber') {
                                    const input = dataSet.querySelector(`[name="${key}_${setNumber}"]`);
                                    if (input && !input.readOnly) {
                                        input.value = setData[key];
                                    }
                                }
                            });

                            // ‡∏´‡∏≤‡∏Å machine ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô select ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô
                            const machVal = setData.machine || '';
                            if (machVal) {
                                const machSel = dataSet.querySelector(`[name="machine_${setNumber}"]`);
                                if (machSel) {
                                    const exists = Array.from(machSel.options).some(o => o.value === machVal);
                                    if (!exists) {
                                        const machManual = dataSet.querySelector(`[name="machineManual_${setNumber}"]`);
                                        if (machManual) {
                                            machManual.value = machVal;
                                            machSel.value = '';
                                        }
                                    }
                                }
                            }

                            // ‡∏´‡∏≤‡∏Å employeeA ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô select ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô
                            const empVal = setData.employeeA || '';
                            if (empVal) {
                                const empSel = dataSet.querySelector(`[name="employeeA_${setNumber}"]`);
                                if (empSel) {
                                    const optionFound = Array.from(empSel.options).some(o => o.value === empVal);
                                    if (!optionFound) {
                                        const empManual = dataSet.querySelector(`[name="employeeAManual_${setNumber}"]`);
                                        if (empManual) {
                                            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "ID - ‡∏ä‡∏∑‡πà‡∏≠" ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡πÉ‡∏ô master list ‡∏î‡πâ‡∏ß‡∏¢ id
                                            const emp = employees.find(e => e.id === empVal);
                                            empManual.value = emp ? `${emp.id} - ${emp.name}` : empVal;
                                            empSel.value = '';
                                        }
                                    }
                                }
                            }

                            // ‡∏´‡∏≤‡∏Å fabricSize ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô select ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô
                            const fabVal = setData.fabricSize || '';
                            if (fabVal) {
                                const fabSel = dataSet.querySelector(`[name="fabricSize_${setNumber}"]`);
                                if (fabSel) {
                                    const optionFound = Array.from(fabSel.options).some(o => o.value === fabVal);
                                    if (!optionFound) {
                                        const fabManual = dataSet.querySelector(`[name="fabricSizeManual_${setNumber}"]`);
                                        if (fabManual) {
                                            fabManual.value = fabVal;
                                            fabSel.value = '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                updateDataSetCount();
                setupSelectHandlers();
                refreshAllSelects();
                try { window.PD2_WAGE_A && window.PD2_WAGE_A.bindWageAForAllSets(); } catch(_){}
                
                console.log('üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                // ‡∏•‡∏ö notification ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á - ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                // showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Reset all data sets to a single fresh set
        function resetToSingleDataSet() {
            try {
                const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
                if (!ok) return;

                // Clear stored data for this shift
                LS.remove('productionData');
                LS.remove('pendingSubmission');

                // Rebuild DOM with only one fresh data set
                const container = document.getElementById('dataContainer');
                if (!container) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö dataContainer');
                container.innerHTML = '';
                // Safer insertion: create wrapper, set innerHTML and append the child to avoid display/render quirks
                const wrapper = document.createElement('div');
                wrapper.innerHTML = generateDataSet(1);
                const child = wrapper.firstElementChild;
                if (child) container.appendChild(child);

                // Reset counters and UI
                dataSetCount = 1;
                updateDataSetCount();
                setupSelectHandlers();
                refreshAllSelects();
                try { window.PD2_WAGE_A && window.PD2_WAGE_A.bindWageAForAllSets(); } catch(_){}

                // Persist the fresh state
                saveToLocalStorage();

                // UX
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showNotification('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'success');
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Recovery System
        function saveDataForRecovery(data) {
            try {
                const recoveryData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                LS.set('pendingSubmission', JSON.stringify(recoveryData));
                console.log('üîÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô');
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ:', error);
            }
        }

        function checkForPendingSubmissions() {
            try {
                const pending = LS.get('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    const timestamp = new Date(recoveryData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - timestamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 1) {
                        // Auto cleanup old data
                        LS.remove('pendingSubmission');
                        console.log('üßπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        // Show recovery modal
                        document.getElementById('recoveryModal').classList.remove('hidden');
                        console.log('üîÑ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á');
                    }
                }
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ:', error);
            }
        }

        function retryPendingSubmission() {
            try {
                const pending = LS.get('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    document.getElementById('recoveryModal').classList.add('hidden');
                    
                    const payload = {
                        action: 'saveData',
                        data: {
                            title: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏∞ A (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô)",
                            timestamp: recoveryData.timestamp,
                            totalSets: recoveryData.data.length,
                            data: recoveryData.data
                        },
                        sheetId: API_CONFIG.sheetId,
                        folderId: API_CONFIG.folderId,
                        timestamp: new Date().toISOString()
                    };
                    
                    showLoading();
                    submitWithRetry(payload, 3, 1);
                }
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'error');
            }
        }

        function discardPendingSubmission() {
            LS.remove('pendingSubmission');
            document.getElementById('recoveryModal').classList.add('hidden');
            showNotification('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        // UI Management Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            // Reset progress steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        function updateProgressStep(stepNumber) {
            // Mark previous steps as completed
            for (let i = 1; i < stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active');
                step.classList.add('completed');
            }
            
            // Mark current step as active
            const currentStep = document.getElementById(`step${stepNumber}`);
            currentStep.classList.add('active');
            currentStep.classList.remove('completed');
        }

                                // load shared PD2 notification module (safe JS loader)
                                (function(){
                                    if (window.PD2Notify) return;
                                    try {
                                        const s = document.createElement('script');
                                        s.src = '../pd2-notify.js';
                                        s.async = false;
                                        s.addEventListener('error', () => { try { console.warn('pd2-notify failed to load'); } catch(_){} });
                                        document.head.appendChild(s);
                                    } catch(_){}
                                })();

        // System Health Check Function

        // ============================================
        // Multi-Language System (i18n)
        // ============================================
        
        // Get current language from localStorage or default to Thai
        let currentLang = localStorage.getItem('pd2_language') || 'th';
        
        // Language display names
        const languageNames = {
            'th': '‡πÑ‡∏ó‡∏¢',
            'en': 'English',
            'my': '·Äô·Äº·Äî·Ä∫·Äô·Ä¨',
            'mnw': '·Äô·Äî·Ä∫'
        };
        
        // Toggle language menu dropdown
        function toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            menu.classList.toggle('hidden');
        }
        
        // Close language menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('languageMenu');
            const button = event.target.closest('button[onclick="toggleLanguageMenu()"]');
            
            if (!button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
        
        // Change language function
        function changeLanguage(lang) {
            if (!translations[lang]) {
                console.error('Language not supported:', lang);
                return;
            }
            
            currentLang = lang;
            localStorage.setItem('pd2_language', lang);
            
            // Update current language display
            document.getElementById('currentLanguage').textContent = languageNames[lang];
            
            // Update all elements with data-i18n attribute
            updatePageLanguage();
            
            // Hide menu after selection
            document.getElementById('languageMenu').classList.add('hidden');
            
            // Show notification
            try {
                if (window.PD2Notify) {
                    window.PD2Notify.show(
                        translations[lang]['lang.select'] || 'Language changed',
                        'success',
                        3000
                    );
                }
            } catch(e) {
                console.log('Language changed to:', languageNames[lang]);
            }
        }
        
        // Update all translatable elements on the page
        function updatePageLanguage() {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLang];
            
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    // Update text content
                    element.textContent = currentTranslations[key];
                    
                    // Update placeholder if it's an input
                    if (element.tagName === 'INPUT' && element.placeholder) {
                        element.placeholder = currentTranslations[key];
                    }
                }
            });
            
            // Update document title
            if (currentTranslations['system.title']) {
                document.title = currentTranslations['system.title'] + ' - ' + 
                                 (currentTranslations['shift.a'] || 'Shift A');
            }
        }
        
        // Initialize language on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial language display
            document.getElementById('currentLanguage').textContent = languageNames[currentLang];
            
            // Apply saved language
            if (currentLang !== 'th') {
                updatePageLanguage();
            }
        });

        // Note: First data set is already created in the main DOMContentLoaded event
    </script>
</body>
</html>
